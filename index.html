<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bayrak Mitarbeiter-Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --blue-dark: #004b7a;
            --blue-light: #e7f2fb;
            --orange: #f57c00;
            --grey-bg: #f5f5f5;
            --card-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--grey-bg);
            color: #333;
        }

        /* TOP-LEISTE */
        header {
            background: var(--blue-dark);
            color: #fff;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .brand-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .brand-subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-user {
            font-size: 0.85rem;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-top {
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            background: #c0392b;
            color: #fff;
        }

        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 10px 25px 10px;
        }

        /* AUTH-BEREICH */
        #auth-section {
            max-width: 460px;
            margin: 40px auto;
            background: #fff;
            padding: 20px 18px 22px 18px;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
        }

        #auth-section h2 {
            margin-top: 0;
        }

        #auth-section h3 {
            margin: 10px 0 4px 0;
            font-size: 1rem;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        input[type="email"],
        input[type="password"],
        input[type="text"],
        select { 
            width: 100%;
            padding: 7px 8px;
            margin-top: 3px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            background: #fff;
        }

        .btn-primary,
        .btn-secondary {
            margin-top: 12px;
            padding: 8px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--blue-dark);
            color: #fff;
        }

        .btn-secondary {
            background: #777;
            color: #fff;
            margin-left: 6px;
        }

        .btn-link {
            background: transparent;
            border: none;
            color: var(--blue-dark);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 8px;
        }

        .info {
            font-size: 0.8rem;
            color: #555;
            margin-top: 8px;
        }

        .error {
            color: #b00020;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .success {
            color: #0a7a1b;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .separator-line {
            margin: 14px 0;
            border-top: 1px solid #eee;
        }

        /* PORTAL-LAYOUT (Sidebar + Inhalt) */
        #portal-section {
            background: transparent;
        }

        .portal-layout {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .portal-layout {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            padding: 14px 12px;
            align-self: flex-start; /* Fixiert Sidebar, wenn Hauptcontent lang ist */
        }

        .sidebar-title {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .sidebar-user {
            font-size: 0.8rem;
            margin-bottom: 12px;
            color: #555;
        }

        .sidebar-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-list li {
            padding: 7px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.1s;
        }

        .sidebar-list li span.icon {
            width: 18px;
            text-align: center;
        }

        .sidebar-list li.active,
        .sidebar-list li:hover {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .sidebar-admin {
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #777;
        }

        .request-badge {
            display: inline-block;
            background: #e53935;
            color: #fff;
            border-radius: 999px;
            font-size: 0.7rem;
            padding: 0 6px;
            margin-left: 4px;
            min-width: 16px;
            text-align: center;
            line-height: 1.4;
        }

        /* Hauptbereich */
        .main-content {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            padding: 16px 16px 18px 16px;
        }

        .portal-greeting {
            margin-bottom: 14px;
        }

        .portal-greeting h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .portal-greeting p {
            margin: 4px 0 0 0;
            font-size: 0.85rem;
            color: #666;
        }

        .role-badge {
            display: inline-block;
            margin-left: 6px;
            font-size: 0.75rem;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* SECTIONS + DASHBOARD-TILES */
        .portal-section-content {
            margin-top: 10px;
        }

        .tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 6px;
        }

        .tile-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }

        .tile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            background: #fdfdfd;
        }

        .tile-card.active {
            border: 2px solid var(--orange);
            padding: 14px 10px;
        }

        .tile-icon {
            font-size: 1.6rem;
            margin-bottom: 6px;
            color: var(--orange);
        }

        .tile-title {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .tile-sub {
            font-size: 0.8rem;
            color: #777;
        }

        h3.section-title {
            margin: 12px 0 6px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* DOKUMENT-KATEGORIEN */
        .document-category {
            margin-top: 14px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .document-category h4 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .document-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0 0;
        }

        .document-item {
            background: #ffffff;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        .document-item-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .document-item-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .document-item a {
            background: var(--blue-dark);
            color: #fff;
            padding: 6px 9px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .doc-badge-new {
            display: inline-block;
            background: #ff9800;
            color: #fff;
            border-radius: 999px;
            font-size: 0.7rem;
            padding: 0 6px;
            margin-left: 4px;
        }
        
        /* ADMIN OVERVIEW */
        .admin-overview-section {
            background: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .admin-overview-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px dotted #eee;
        }
        
        .admin-overview-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .admin-overview-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .admin-overview-details {
            font-size: 0.8rem;
            color: #555;
            margin-left: 10px;
        }

        /* ADMIN: MITARBEITER-KACHELN */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .employee-card {
            border-radius: 6px;
            padding: 10px 10px 12px 10px;
            box-shadow: var(--card-shadow);
            background: #fafafa;
            display: grid;
            grid-template-columns: 48px minmax(0, 1fr);
            gap: 8px;
            font-size: 0.85rem;
        }

        .employee-card.pending {
            border: 2px solid #ff9800;
            background: #fff7e6;
        }

        .employee-card.admin {
            border: 2px solid var(--blue-dark);
            background: #e7f2fb;
        }

        .employee-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #555;
            border: 2px solid #4caf50;
        }

        .employee-info-main {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .employee-info-sub {
            font-size: 0.8rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .employee-role-selector {
            margin-top: 4px;
            display: flex;
            gap: 4px;
            align-items: center;
            font-size: 0.75rem;
            flex-wrap: wrap;
        }

        .employee-role-selector label {
             margin: 0;
             margin-right: 4px;
        }

        .employee-role-selector select {
            font-size: 0.75rem;
            padding: 3px 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: auto;
            flex: 1;
            min-width: 80px;
        }

        .employee-actions {
            grid-column: 1 / 3;
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 4px 6px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            line-height: 1.5;
        }

        .btn-small.primary {
            background: var(--blue-dark);
            color: #fff;
        }

        .btn-small.grey {
            background: #777;
            color: #fff;
        }

        .btn-small.approve {
            background: #2e7d32;
            color: #fff;
        }

        .admin-message {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .employee-category-wrapper {
            margin-bottom: 16px;
        }

        .employee-category-heading {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 18px 0 6px 0;
            color: #444;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .employee-category-heading:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* SETTINGS */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .settings-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 12px 12px 14px 12px;
            box-shadow: var(--card-shadow);
        }

        .settings-card h4 {
            margin: 0 0 6px 0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .settings-card p {
            margin: 4px 0 8px 0;
            font-size: 0.8rem;
            color: #666;
        }

        .settings-inline {
            display: flex;
            gap: 8px;
        }

        .settings-inline > div {
            flex: 1;
        }

        .settings-message {
            margin-top: 6px;
            font-size: 0.8rem;
        }

        /* PENDING-SECTION (nicht freigegeben) */
        #pending-section {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            padding: 20px 18px 22px 18px;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
        }

        #pending-section h2 {
            margin-top: 0;
        }

        @media (max-width: 600px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .top-right {
                align-self: stretch;
                justify-content: space-between;
            }
            .top-user {
                max-width: none;
            }

            .settings-inline {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="brand-logo">B</div>
        <div>
            <div class="brand-title">Bayrak Mitarbeiter-Portal</div>
            <div class="brand-subtitle">Interne Web-App ¬∑ Testversion</div>
        </div>
    </div>
    <div class="top-right">
        <div class="top-user" id="top-user-text"></div>
        <span id="inactivity-timer" class="hidden" style="color: #f57c00; font-weight: bold; font-size: 0.8rem; margin-right: 6px;">10:00</span>
        <button id="logout-btn" class="btn-top hidden">Abmelden</button>
    </div>
</header>

<main>
    <section id="auth-section">
        <h2>Anmeldung</h2>
        <div id="auth-error" class="error hidden"></div>
        <div id="auth-success" class="success hidden"></div>

        <div id="login-box">
            <h3>Einloggen</h3>
            <label for="email">E-Mail</label>
            <input type="email" id="email" placeholder="deine@email.de" autocomplete="username">

            <label for="password">Passwort</label>
            <input type="password" id="password" placeholder="Passwort" autocomplete="current-password">

            <button id="login-btn" class="btn-primary">Einloggen</button>

            <button id="forgot-password-btn" class="btn-link" type="button">Passwort vergessen?</button>

            <div class="separator-line"></div>

            <p class="info">Sie haben noch kein Konto?</p>
            <button id="show-register-btn" class="btn-secondary">Neu anmelden</button>
        </div>

        <div id="register-box" class="hidden">
            <h3>Neu anmelden</h3>

            <label for="reg-first-name">Vorname</label>
            <input type="text" id="reg-first-name" placeholder="Vorname" autocomplete="given-name">

            <label for="reg-last-name">Nachname</label>
            <input type="text" id="reg-last-name" placeholder="Nachname" autocomplete="family-name">

            <label for="reg-email">E-Mail</label>
            <input type="email" id="reg-email" placeholder="E-Mail" autocomplete="email">

            <label for="reg-password">Passwort</label>
            <input type="password" id="reg-password" placeholder="Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen" autocomplete="new-password">

            <label for="reg-password2">Passwort wiederholen</label>
            <input type="password" id="reg-password2" placeholder="Passwort best√§tigen" autocomplete="new-password">

            <button id="register-btn" class="btn-primary">Registrierung abschlie√üen</button>
            <button id="back-to-login-btn" class="btn-secondary">Zur√ºck zum Login</button>

            <p class="info">
                Nach der Registrierung erhalten Sie eine E-Mail zur Best√§tigung Ihrer Adresse.<br>
                Anschlie√üend muss ein Administrator Ihren Zugang freigeben, bevor Sie das Portal nutzen k√∂nnen.
            </p>
        </div>

        <div id="reset-box" class="hidden">
            <h3>Neues Passwort setzen</h3>
            <p class="info">
                Sie haben einen Link ‚ÄûPasswort zur√ºcksetzen‚Äú verwendet. Bitte w√§hlen Sie jetzt ein neues Passwort.
            </p>

            <label for="reset-password">Neues Passwort</label>
            <input type="password" id="reset-password" placeholder="Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen" autocomplete="new-password">

            <label for="reset-password2">Passwort wiederholen</label>
            <input type="password" id="reset-password2" placeholder="Neues Passwort best√§tigen" autocomplete="new-password">

            <button id="reset-password-btn" class="btn-primary">Passwort speichern</button>
        </div>
    </section>

    <section id="pending-section" class="hidden">
        <h2>Registrierung ausstehend</h2>
        <p id="pending-message" class="info"></p>
        <p class="info">
            Ihre Registrierung wurde erfolgreich gespeichert und Ihre E-Mail-Adresse ist best√§tigt.<br>
            Ein Administrator wird Ihren Zugang pr√ºfen und freigeben. Sobald dies erfolgt ist, k√∂nnen Sie sich normal einloggen.
        </p>
        <button id="pending-logout-btn" class="btn-primary">Abmelden</button>
    </section>

    <section id="portal-section" class="hidden">
        <div class="portal-layout">
            <aside class="sidebar">
                <div class="sidebar-title">Mitarbeiterportal</div>
                <div class="sidebar-user" id="sidebar-user-role"></div>

                <ul class="sidebar-list" id="sidebar-nav">
                    <li data-target="section-dashboard" class="active">
                        <span class="icon">üè†</span> <span>Startseite</span>
                    </li>
                    <li data-target="section-training-records">
                        <span class="icon">‚úÖ</span> <span>Dokumente & Uploads</span>
                    </li>
                    <li data-target="section-timesheet">
                        <span class="icon">üïí</span> <span>Stundenzettel</span>
                    </li>
                    <li data-target="section-sicknotes">
                        <span class="icon">üè•</span> <span>Krankmeldungen</span>
                    </li>
                    <li data-target="section-settings">
                        <span class="icon">‚öôÔ∏è</span> <span>Einstellungen</span>
                    </li>
                    <li data-target="section-admin" id="sidebar-admin-link" class="hidden">
                        <span class="icon">üõ†</span> <span>Admin ¬∑ Mitarbeiter</span>
                        <span id="sidebar-admin-badge" class="request-badge hidden"></span>
                    </li>
                    <li data-target="section-admin-uploads" id="sidebar-admin-uploads-link" class="hidden">
                        <span class="icon">üì•</span> <span>Admin ¬∑ Uploads</span>
                    </li>
                </ul>

                <div id="sidebar-admin-label" class="sidebar-admin hidden">
                    Sie sind <strong>Administrator</strong> und k√∂nnen Mitarbeiter &amp; Rollen verwalten.
                </div>
            </aside>

            <div class="main-content">
                <div class="portal-greeting">
                    <h2>
                        Guten Tag,
                        <span id="user-name-text">Mitarbeiter</span>
                        <span id="role-badge" class="role-badge hidden"></span>
                    </h2>
                    <p>Willkommen im Bayrak Mitarbeiter-Portal. W√§hlen Sie eine Kachel oder einen Men√ºpunkt.</p>
                </div>

                <div id="section-dashboard" class="portal-section-content">
                    <div class="tile-grid">
                        <div class="tile-card active" data-target="section-training-records">
                            <div class="tile-icon">‚úÖ</div>
                            <div class="tile-title">Dokumente & Uploads</div>
                            <div class="tile-sub">Nachweise, Stundenzettel, Krankmeldungen</div>
                        </div>
                        <div class="tile-card" data-target="section-timesheet">
                            <div class="tile-icon">üïí</div>
                            <div class="tile-title">Stundenzettel</div>
                            <div class="tile-sub">Arbeitszeiten erfassen (Platzhalter)</div>
                        </div>
                        <div class="tile-card" data-target="section-sicknotes">
                            <div class="tile-icon">üè•</div>
                            <div class="tile-title">Krankmeldungen</div>
                            <div class="tile-sub">AU-Bescheinigung hochladen</div>
                        </div>
                        <div class="tile-card" data-target="section-settings">
                            <div class="tile-icon">‚öôÔ∏è</div>
                            <div class="tile-title">Einstellungen</div>
                            <div class="tile-sub">Profil & Passwort</div>
                        </div>
                        <div id="tile-admin" class="tile-card hidden" data-target="section-admin">
                            <div class="tile-icon">üë•</div>
                            <div class="tile-title">
                                Mitarbeiter (Admin)
                                <span id="tile-admin-badge" class="request-badge hidden"></span>
                            </div>
                            <div class="tile-sub">√úbersicht & Rollen</div>
                        </div>
                        <div id="tile-admin-uploads" class="tile-card hidden" data-target="section-admin-uploads">
                            <div class="tile-icon">üì•</div>
                            <div class="tile-title">Admin Uploads</div>
                            <div class="tile-sub">Dateien f√ºr Mitarbeiter hochladen</div>
                        </div>
                    </div>
                </div>

                <div id="section-training-records" class="portal-section-content hidden">
                    <h3 class="section-title">Dokumente, Nachweise & Uploads</h3>
                    <p class="info">
                        In diesem Bereich sehen Sie:
                        <br>‚Ä¢ Unterweisungsnachweise (vom Admin bereitgestellt)
                        <br>‚Ä¢ Ihre hochgeladenen Stundenzettel-Nachweise
                        <br>‚Ä¢ Ihre hochgeladenen Krankmeldungen-Nachweise
                    </p>

                    <div class="document-category">
                        <h4>Unterweisungen (vom Admin bereitgestellt)</h4>
                        <div id="docs-unterweisungen-message" class="info">Es sind keine Unterweisungen f√ºr Sie hinterlegt.</div>
                        <ul id="docs-unterweisungen-list" class="document-list"></ul>
                    </div>

                    <div class="document-category">
                        <h4>Stundenzettel-Nachweise (Ihr Upload)</h4>
                        <p class="info">
                            Laden Sie hier Ihre Stundenzettel / Rapporte als PDF oder Foto hoch.
                        </p>
                        <button id="upload-timesheet-btn" class="btn-primary">Stundenzettel hochladen</button>
                        <input type="file" id="upload-timesheet-input" accept="image/*,application/pdf" capture="environment" class="hidden">
                        <div id="docs-timesheets-message" class="info">Es wurden noch keine Stundenzettel von Ihnen hochgeladen.</div>
                        <ul id="docs-timesheets-list" class="document-list"></ul>
                    </div>
                </div>

                <div id="section-sicknotes" class="portal-section-content hidden">
                    <h3 class="section-title">Krankmeldungen (Ihr Upload)</h3>
                    <div class="document-category" style="padding-top: 0; border-top: none;">
                        <p class="info">
                            Hier k√∂nnen Sie Ihre Krankmeldungen (AU-Bescheinigungen) als Foto oder PDF hochladen. Die Admins sehen diese in ihrer √úbersicht.
                        </p>
                        <button id="upload-sicknote-btn" class="btn-primary">Krankmeldung hochladen</button>
                        <input type="file" id="upload-sicknote-input" accept="image/*,application/pdf" capture="environment" class="hidden">
                        <div id="docs-sicknotes-message" class="info"></div>
                        <h4 style="margin-top:18px;">Ihre hochgeladenen Krankmeldungen</h4>
                        <div id="sicknotes-user-message" class="info">Es wurden noch keine Krankmeldungen von Ihnen hochgeladen.</div>
                        <ul id="docs-sicknotes-list" class="document-list"></ul>
                    </div>
                </div>

                <div id="section-timesheet" class="portal-section-content hidden">
                    <h3 class="section-title">Stundenzettel</h3>
                    <p class="info">
                        Hier wird sp√§ter die Stundenzettel-Funktion integriert (mit Speicherung in Supabase).
                        <br><strong>Aktuell ist dies nur ein Platzhalter.</strong>
                    </p>
                </div>

                <div id="section-settings" class="portal-section-content hidden">
                    <h3 class="section-title">Einstellungen</h3>
                    <p class="info">
                        Hier k√∂nnen Sie Ihre Profildaten bearbeiten und Ihr Passwort √§ndern.
                    </p>

                    <div class="settings-grid">
                        <div class="settings-card">
                            <h4>Profildaten</h4>
                            <p>Aktualisieren Sie hier Ihren Namen.</p>

                            <div class="settings-inline">
                                <div>
                                    <label for="settings-first-name">Vorname</label>
                                    <input type="text" id="settings-first-name" placeholder="Vorname">
                                </div>
                                <div>
                                    <label for="settings-last-name">Nachname</label>
                                    <input type="text" id="settings-last-name" placeholder="Nachname">
                                </div>
                            </div>

                            <label for="settings-email">E-Mail</label>
                            <input type="email" id="settings-email" disabled>
                            
                            <label for="settings-employment-type" id="settings-employment-label">Besch√§ftigungsart</label>
                            <select id="settings-employment-type">
                                <option value="fulltime">Vollzeit</option>
                                <option value="minijob">Minijob</option>
                            </select>

                            <button id="settings-save-profile" class="btn-primary">Profil speichern</button>
                            <div id="settings-profile-msg" class="settings-message"></div>
                        </div>

                        <div class="settings-card">
                            <h4>Passwort √§ndern</h4>
                            <p>Das neue Passwort muss mindestens 8 Zeichen, einen Gro√übuchstaben und eine Zahl oder ein Sonderzeichen enthalten.</p>

                            <label for="settings-current-password">Aktuelles Passwort</label>
                            <input type="password" id="settings-current-password" placeholder="Aktuelles Passwort" autocomplete="current-password">

                            <label for="settings-new-password">Neues Passwort</label>
                            <input type="password" id="settings-new-password" placeholder="Neues Passwort" autocomplete="new-password">

                            <label for="settings-new-password2">Neues Passwort wiederholen</label>
                            <input type="password" id="settings-new-password2" placeholder="Neues Passwort best√§tigen" autocomplete="new-password">

                            <button id="settings-change-password" class="btn-primary">Passwort √§ndern</button>
                            <div id="settings-password-msg" class="settings-message"></div>
                        </div>
                    </div>
                </div>

                <div id="section-admin" class="portal-section-content hidden">
                    <h3 class="section-title"> Admin ¬∑ Mitarbeiter√ºbersicht <span id="admin-requests-counter" class="request-badge hidden"></span> </h3>
                    <p class="info"> Hier sehen Sie alle im System angelegten Mitarbeiter. Offene Registrierungs-Anfragen k√∂nnen Sie im Bereich ‚ÄûOffene Anfragen‚Äú freigeben. </p>
                    
                    <div id="pending-requests-box" class="hidden">
                        <h4 class="employee-category-heading" style="margin-top:0;">Offene Anfragen (noch nicht freigegeben)</h4>
                        <div id="pending-employee-grid" class="employee-grid"></div>
                    </div>
                    
                    <div id="approved-employees-content">
                        </div>
                    
                    <div class="admin-message" id="admin-message"></div>

                    <h4 class="employee-category-heading">Stundenzettel-Uploads (alle Mitarbeiter)</h4>
                    <div id="admin-timesheets-new-count" class="info"></div>
                    <div id="admin-timesheets-overview" class="admin-overview-section"></div>
                    
                    <h4 class="employee-category-heading">Krankmeldungen-Uploads (alle Mitarbeiter)</h4>
                    <div id="admin-sicknotes-new-count" class="info"></div>
                    <div id="admin-sicknotes-overview" class="admin-overview-section"></div>
                </div>

                <div id="section-admin-uploads" class="portal-section-content hidden">
                    <h3 class="section-title">Admin ¬∑ Datei-Uploads f√ºr Mitarbeiter</h3>
                    <div id="admin-doc-manager" class="settings-card">
                        <h4 style="margin-top:0;">Dokument f√ºr Mitarbeiter hochladen</h4>
                        <p>
                            Laden Sie ein Dokument hoch und w√§hlen Sie die Zielgruppe sowie die Dokumenten-Kategorie.
                        </p>

                        <label for="admin-upload-category">Kategorie</label>
                        <select id="admin-upload-category">
                            <option value="unterweisung">Unterweisungsnachweis</option>
                            </select>

                        <label for="admin-unterweisungen-scope" style="margin-top: 10px;">Zielgruppe</label>
                        <select id="admin-unterweisungen-scope">
                            <option value="all">Alle Mitarbeiter (freigegeben)</option>
                            <option value="fulltime">Nur Vollzeit-Mitarbeiter (freigegeben)</option>
                            <option value="minijob">Nur Minijob-Mitarbeiter (freigegeben)</option>
                            <option value="single">Einzelner Mitarbeiter</option>
                        </select>

                        <div id="admin-unterweisungen-user-select-wrapper" class="hidden">
                            <label for="admin-unterweisungen-user-select" style="margin-top: 10px;">Mitarbeiter ausw√§hlen</label>
                            <select id="admin-unterweisungen-user-select"></select>
                        </div>

                        <label for="admin-unterweisungen-input" style="margin-top: 10px;">Datei ausw√§hlen (PDF/Bild)</label>
                        <input type="file" id="admin-unterweisungen-input" accept="image/*,application/pdf">

                        <button id="admin-unterweisungen-upload-btn" class="btn-primary" style="margin-top: 10px;">Dokument hochladen</button>
                        <div id="admin-unterweisungen-message" class="settings-message"></div>
                    </div>
                </div>

                <div id="section-employee-detail" class="portal-section-content hidden">
                    <h3 class="section-title">Mitarbeiter-Details: <span id="employee-detail-info-title"></span></h3>
                    <div id="employee-detail-meta" class="info" style="margin-bottom:12px;"></div>
                    <button id="employee-detail-back-btn" class="btn-secondary" style="margin-bottom: 15px;">Zur√ºck zur √úbersicht</button>

                    <h4>Hochgeladene Dokumente</h4>
                    <ul id="employee-detail-docs" class="document-list"></ul>
                </div>

            </div>
        </div>
    </section>
</main>

<script type="module">
    // --- KONFIGURATION: BITTE HIER IHRE URL & KEY EINF√úGEN ---
    const SUPABASE_URL = 'https://njjnyodpwpkpjdjxbmvo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qam55b2Rwd3BrcGpkanhibXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTg5MDQsImV4cCI6MjA3OTczNDkwNH0.aHBJ_g1zHZlWjceUFas_v2lYfrcjv8PuhPEAFpGj3_E';
    const STORAGE_BUCKET = 'documents';

    // Supabase-Client initialisieren
    // Hinweis: supabase wird global durch das CDN-Script bereitgestellt,
    // aber wir verwenden createClient, um uns mit den Credentials zu verbinden.
    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Globale Variablen
    let currentUser = null;
    let currentProfile = null;
    let allProfilesCache = []; // F√ºr Admin-Auswahl
    
    // DOM-Referenzen
    const authSection = document.getElementById('auth-section');
    const portalSection = document.getElementById('portal-section');
    const pendingSection = document.getElementById('pending-section');
    const loginBox = document.getElementById('login-box');
    const registerBox = document.getElementById('register-box');
    const resetBox = document.getElementById('reset-box');
    const authError = document.getElementById('auth-error');
    const authSuccess = document.getElementById('auth-success');
    
    // Inputs Auth
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const forgotPasswordBtn = document.getElementById('forgot-password-btn');
    const showRegisterBtn = document.getElementById('show-register-btn');
    const backToLoginBtn = document.getElementById('back-to-login-btn');
    
    // Register Inputs
    const regFirstName = document.getElementById('reg-first-name');
    const regLastName = document.getElementById('reg-last-name');
    const regEmail = document.getElementById('reg-email');
    const regPassword = document.getElementById('reg-password');
    const regPassword2 = document.getElementById('reg-password2');
    const registerBtn = document.getElementById('register-btn');
    
    // Reset Inputs
    const resetPasswordInput = document.getElementById('reset-password');
    const resetPassword2Input = document.getElementById('reset-password2');
    const resetPasswordBtn = document.getElementById('reset-password-btn');
    
    // Top Bar
    const topUserText = document.getElementById('top-user-text');
    const logoutBtn = document.getElementById('logout-btn');
    const pendingLogoutBtn = document.getElementById('pending-logout-btn');
    const pendingMessage = document.getElementById('pending-message');
    
    // Portal Basic
    const userNameText = document.getElementById('user-name-text');
    const roleBadge = document.getElementById('role-badge');
    const sidebarUserRole = document.getElementById('sidebar-user-role');
    const sidebarNav = document.getElementById('sidebar-nav');
    
    // Admin Elements
    const sidebarAdminLink = document.getElementById('sidebar-admin-link');
    const sidebarAdminBadge = document.getElementById('sidebar-admin-badge');
    const sidebarAdminLabel = document.getElementById('sidebar-admin-label');
    const sidebarAdminUploadsLink = document.getElementById('sidebar-admin-uploads-link');
    const tileAdmin = document.getElementById('tile-admin');
    const tileAdminBadge = document.getElementById('tile-admin-badge');
    const tileAdminUploads = document.getElementById('tile-admin-uploads');
    
    // Admin Content
    const pendingRequestsBox = document.getElementById('pending-requests-box');
    const pendingEmployeeGrid = document.getElementById('pending-employee-grid');
    const approvedEmployeesContent = document.getElementById('approved-employees-content');
    const adminMessage = document.getElementById('admin-message');
    const adminRequestsCounter = document.getElementById('admin-requests-counter');
    const adminTimesheetsOverview = document.getElementById('admin-timesheets-overview');
    const adminSicknotesOverview = document.getElementById('admin-sicknotes-overview');
    const adminTimesheetsNewCount = document.getElementById('admin-timesheets-new-count');
    const adminSicknotesNewCount = document.getElementById('admin-sicknotes-new-count');

    // Admin Uploads
    const adminUploadCategory = document.getElementById('admin-upload-category');
    const adminUnterwScope = document.getElementById('admin-unterweisungen-scope');
    const adminUnterwUserSelectWrapper = document.getElementById('admin-unterweisungen-user-select-wrapper');
    const adminUnterwUserSelect = document.getElementById('admin-unterweisungen-user-select');
    const adminUnterwInput = document.getElementById('admin-unterweisungen-input');
    const adminUnterwUploadBtn = document.getElementById('admin-unterweisungen-upload-btn');
    const adminUnterwMessage = document.getElementById('admin-unterweisungen-message');
    
    // Employee Detail
    const employeeDetailInfoTitle = document.getElementById('employee-detail-info-title');
    const employeeDetailMeta = document.getElementById('employee-detail-meta');
    const employeeDetailDocs = document.getElementById('employee-detail-docs');
    const employeeDetailBackBtn = document.getElementById('employee-detail-back-btn');

    // Documents
    const docsUnterwList = document.getElementById('docs-unterweisungen-list');
    const docsUnterwMessage = document.getElementById('docs-unterweisungen-message');
    const uploadTimesheetBtn = document.getElementById('upload-timesheet-btn');
    const uploadTimesheetInput = document.getElementById('upload-timesheet-input');
    const docsTimesheetsList = document.getElementById('docs-timesheets-list');
    const docsTimesheetsMessage = document.getElementById('docs-timesheets-message');
    const uploadSicknoteBtn = document.getElementById('upload-sicknote-btn');
    const uploadSicknoteInput = document.getElementById('upload-sicknote-input');
    const docsSicknotesList = document.getElementById('docs-sicknotes-list');
    const docsSicknotesMessage = document.getElementById('docs-sicknotes-message');
    const sicknotesUserMessage = document.getElementById('sicknotes-user-message');

    // Settings
    const settingsFirstName = document.getElementById('settings-first-name');
    const settingsLastName = document.getElementById('settings-last-name');
    const settingsEmail = document.getElementById('settings-email');
    const settingsEmploymentType = document.getElementById('settings-employment-type');
    const settingsSaveProfile = document.getElementById('settings-save-profile');
    const settingsProfileMsg = document.getElementById('settings-profile-msg');
    
    const settingsCurrentPw = document.getElementById('settings-current-password');
    const settingsNewPw = document.getElementById('settings-new-password');
    const settingsNewPw2 = document.getElementById('settings-new-password2');
    const settingsChangePw = document.getElementById('settings-change-password');
    const settingsPasswordMsg = document.getElementById('settings-password-msg');

    // Timer
    const inactivityTimerEl = document.getElementById('inactivity-timer');
    const INACTIVITY_LIMIT_MS = 10 * 60 * 1000; // 10 Min
    let inactivityTimeout;
    let timerInterval;
    let timeRemaining = INACTIVITY_LIMIT_MS / 1000;

    // --- HELPER FUNCTIONS ---

    function isStrongPassword(pw) {
        if (!pw || pw.length < 8) return false;
        // Min 8 chars, 1 Uppercase, 1 Digit OR Special Char
        const hasUpper = /[A-Z√Ñ√ñ√ú]/.test(pw);
        const hasDigitOrSpecial = /[0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/.test(pw);
        return hasUpper && hasDigitOrSpecial;
    }

    function makeSafeFileName(name) {
        return name.replace(/[^a-zA-Z0-9._-]/g, '_');
    }

    function showAuthError(msg) {
        authError.textContent = msg;
        authError.classList.remove('hidden');
        authSuccess.classList.add('hidden');
    }

    function showAuthSuccess(msg) {
        authSuccess.textContent = msg;
        authSuccess.classList.remove('hidden');
        authError.classList.add('hidden');
    }

    function clearAuthMessages() {
        authError.classList.add('hidden');
        authSuccess.classList.add('hidden');
    }

    // --- TIMER LOGIC ---
    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = Math.floor(timeRemaining % 60);
        inactivityTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function handleInactivityLogout() {
        await supabaseClient.auth.signOut();
        alert('Aus Sicherheitsgr√ºnden wurden Sie nach 10 Minuten Inaktivit√§t abgemeldet.');
        showLogin();
    }

    function resetInactivityTimer() {
        if (!currentUser) return; // Only if logged in

        clearTimeout(inactivityTimeout);
        clearInterval(timerInterval);

        timeRemaining = INACTIVITY_LIMIT_MS / 1000;
        inactivityTimerEl.classList.remove('hidden');
        updateTimerDisplay();

        timerInterval = setInterval(() => {
            timeRemaining--;
            if (timeRemaining < 0) timeRemaining = 0;
            updateTimerDisplay();
        }, 1000);

        inactivityTimeout = setTimeout(() => {
            clearInterval(timerInterval);
            handleInactivityLogout();
        }, INACTIVITY_LIMIT_MS);
    }

    // Attach events for timer reset
    ['click', 'keydown', 'mousemove', 'scroll', 'touchstart'].forEach(evt => {
        window.addEventListener(evt, resetInactivityTimer);
    });

    // --- NAVIGATION ---

    function setActiveSection(targetId) {
        const sections = [
            'section-dashboard', 'section-training-records', 'section-timesheet',
            'section-sicknotes', 'section-settings', 'section-admin',
            'section-admin-uploads', 'section-employee-detail'
        ];
        
        sections.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                if(id === targetId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
        });

        // Sidebar Active State
        const items = sidebarNav.querySelectorAll('li');
        items.forEach(li => {
            const t = li.getAttribute('data-target');
            if(t === targetId) li.classList.add('active');
            else li.classList.remove('active');
        });

        // Tile Active State
        document.querySelectorAll('.tile-card').forEach(tile => {
            const t = tile.getAttribute('data-target');
            if(t === targetId) tile.classList.add('active');
            else tile.classList.remove('active');
        });

        // Load content on demand
        if(targetId === 'section-training-records' || targetId === 'section-sicknotes') {
            loadDocumentsForUser(currentUser);
        }
        if(targetId === 'section-admin' && currentProfile?.role === 'admin') {
            loadEmployeeGrid();
            loadAdminDocumentOverviews();
        }
    }

    function initNavigation() {
        sidebarNav.querySelectorAll('li').forEach(li => {
            li.addEventListener('click', () => {
                const target = li.getAttribute('data-target');
                if(target) setActiveSection(target);
            });
        });
        document.querySelectorAll('.tile-card').forEach(tile => {
            tile.addEventListener('click', () => {
                const target = tile.getAttribute('data-target');
                if(target) setActiveSection(target);
            });
        });
        employeeDetailBackBtn.addEventListener('click', () => {
            setActiveSection('section-admin');
        });
    }

    // --- AUTH FLOW UI ---

    function showLogin() {
        currentUser = null;
        currentProfile = null;
        clearTimeout(inactivityTimeout);
        clearInterval(timerInterval);
        inactivityTimerEl.classList.add('hidden');

        authSection.classList.remove('hidden');
        portalSection.classList.add('hidden');
        pendingSection.classList.add('hidden');
        loginBox.classList.remove('hidden');
        registerBox.classList.add('hidden');
        resetBox.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        topUserText.textContent = '';
        clearAuthMessages();
    }

    function showPending(user) {
        currentUser = user;
        authSection.classList.add('hidden');
        portalSection.classList.add('hidden');
        pendingSection.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        topUserText.textContent = `${user.email} (wartet auf Freigabe)`;
        pendingMessage.textContent = `Angemeldet als: ${user.email}. Bitte warten Sie auf die Freischaltung.`;
        resetInactivityTimer();
    }

    async function showPortal(user) {
        currentUser = user;
        // Load Profile
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (error || !profile) {
            console.error('Profil nicht gefunden', error);
            showPending(user);
            return;
        }
        currentProfile = profile;

        if (!profile.is_approved) {
            showPending(user);
            return;
        }

        // Show Portal
        authSection.classList.add('hidden');
        pendingSection.classList.add('hidden');
        portalSection.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');

        const name = profile.full_name || user.email;
        const roleText = profile.role === 'admin' ? 'Administrator' : 'Mitarbeiter';
        
        userNameText.textContent = name;
        topUserText.textContent = `${name} (${roleText})`;
        sidebarUserRole.textContent = `Rolle: ${roleText}`;
        
        if (profile.role === 'admin') {
            roleBadge.textContent = 'Administrator';
            roleBadge.classList.remove('hidden');
            
            sidebarAdminLink.classList.remove('hidden');
            sidebarAdminLabel.classList.remove('hidden');
            sidebarAdminUploadsLink.classList.remove('hidden');
            
            tileAdmin.classList.remove('hidden');
            tileAdminUploads.classList.remove('hidden');
            
            // Initial Admin Load
            loadEmployeeGrid(); 
        } else {
            roleBadge.classList.add('hidden');
            sidebarAdminLink.classList.add('hidden');
            sidebarAdminLabel.classList.add('hidden');
            sidebarAdminUploadsLink.classList.add('hidden');
            tileAdmin.classList.add('hidden');
            tileAdminUploads.classList.add('hidden');
        }

        populateSettingsForm(profile, user);
        resetInactivityTimer();
        setActiveSection('section-dashboard');
    }

    // --- SUPABASE STORAGE & DOCS ---

    async function uploadFileToStorage(file, pathPrefix) {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const safeName = makeSafeFileName(file.name);
        const filePath = `${pathPrefix}/${timestamp}_${safeName}`;

        const { data, error } = await supabaseClient.storage
            .from(STORAGE_BUCKET)
            .upload(filePath, file);

        if (error) throw error;

        const { data: publicData } = supabaseClient.storage
            .from(STORAGE_BUCKET)
            .getPublicUrl(filePath);

        return publicData.publicUrl;
    }

    async function insertDocumentRow(userId, title, docType, fileUrl) {
        const { error } = await supabaseClient
            .from('documents')
            .insert({
                user_id: userId,
                title: title,
                doc_type: docType,
                file_url: fileUrl
            });
        if (error) throw error;
    }

    function renderDocumentList(listEl, docs) {
        listEl.innerHTML = '';
        if (!docs || docs.length === 0) return;

        docs.forEach(doc => {
            const li = document.createElement('li');
            li.className = 'document-item';

            const div = document.createElement('div');
            const titleDiv = document.createElement('div');
            titleDiv.className = 'document-item-title';
            titleDiv.textContent = doc.title;
            
            const metaDiv = document.createElement('div');
            metaDiv.className = 'document-item-meta';
            const dateStr = new Date(doc.created_at).toLocaleDateString('de-DE');
            metaDiv.textContent = `${doc.doc_type} ‚Ä¢ ${dateStr}`;

            div.appendChild(titleDiv);
            div.appendChild(metaDiv);

            const link = document.createElement('a');
            link.href = doc.file_url;
            link.target = '_blank';
            link.textContent = '√ñffnen';

            li.appendChild(div);
            li.appendChild(link);
            listEl.appendChild(li);
        });
    }

    async function loadDocumentsForUser(user) {
        const { data: docs, error } = await supabaseClient
            .from('documents')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error(error);
            return;
        }

        const unterweisungen = docs.filter(d => d.doc_type === 'unterweisung' || !d.doc_type);
        const timesheets = docs.filter(d => d.doc_type === 'stundenzettel');
        const sicknotes = docs.filter(d => d.doc_type === 'krankmeldung');

        if(unterweisungen.length > 0) docsUnterwMessage.classList.add('hidden');
        else docsUnterwMessage.classList.remove('hidden');
        renderDocumentList(docsUnterwList, unterweisungen);

        if(timesheets.length > 0) docsTimesheetsMessage.classList.add('hidden');
        else docsTimesheetsMessage.classList.remove('hidden');
        renderDocumentList(docsTimesheetsList, timesheets);

        if(sicknotes.length > 0) sicknotesUserMessage.classList.add('hidden');
        else sicknotesUserMessage.classList.remove('hidden');
        renderDocumentList(docsSicknotesList, sicknotes);
    }

    // --- UPLOAD HANDLERS (USER) ---

    async function handleUserUpload(fileInput, docType, folder) {
        const file = fileInput.files[0];
        if (!file || !currentUser) return;
        
        try {
            const url = await uploadFileToStorage(file, `${folder}/${currentUser.id}`);
            const dateStr = new Date().toLocaleDateString('de-DE');
            const title = `${docType === 'stundenzettel' ? 'Stundenzettel' : 'Krankmeldung'} ${dateStr} ‚Äì ${file.name}`;
            
            await insertDocumentRow(currentUser.id, title, docType, url);
            alert('Upload erfolgreich!');
            loadDocumentsForUser(currentUser);
        } catch (err) {
            alert('Fehler beim Upload: ' + err.message);
        } finally {
            fileInput.value = '';
        }
    }

    uploadTimesheetInput.addEventListener('change', () => handleUserUpload(uploadTimesheetInput, 'stundenzettel', 'stundenzettel'));
    uploadSicknoteInput.addEventListener('change', () => handleUserUpload(uploadSicknoteInput, 'krankmeldung', 'krankmeldungen'));
    
    uploadTimesheetBtn.addEventListener('click', () => uploadTimesheetInput.click());
    uploadSicknoteBtn.addEventListener('click', () => uploadSicknoteInput.click());

    // --- ADMIN AREA ---

    async function loadEmployeeGrid() {
        if (currentProfile?.role !== 'admin') return;

        const { data: profiles, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .order('full_name');

        if (error) {
            adminMessage.textContent = 'Fehler beim Laden der Profile: ' + error.message;
            return;
        }

        allProfilesCache = profiles;

        // Pending
        const pending = profiles.filter(p => !p.is_approved);
        updatePendingBadges(pending.length);
        
        pendingEmployeeGrid.innerHTML = '';
        if (pending.length > 0) {
            pendingRequestsBox.classList.remove('hidden');
            pending.forEach(p => {
                const card = createPendingCard(p);
                pendingEmployeeGrid.appendChild(card);
            });
        } else {
            pendingRequestsBox.classList.add('hidden');
        }

        // Approved Groups
        const approved = profiles.filter(p => p.is_approved);
        const admins = approved.filter(p => p.role === 'admin');
        const fulltime = approved.filter(p => p.role !== 'admin' && p.employment_type === 'fulltime');
        const minijob = approved.filter(p => p.role !== 'admin' && p.employment_type === 'minijob');
        const others = approved.filter(p => p.role !== 'admin' && p.employment_type !== 'fulltime' && p.employment_type !== 'minijob');

        approvedEmployeesContent.innerHTML = '';
        renderGroup('Administratoren', admins);
        renderGroup('Vollzeit-Mitarbeiter', fulltime);
        renderGroup('Minijob-Mitarbeiter', minijob);
        renderGroup('Sonstige Mitarbeiter', others);

        // Update User Select for Uploads
        populateAdminUploadSelect(approved);
    }

    function updatePendingBadges(count) {
        const txt = count > 0 ? count : '';
        sidebarAdminBadge.textContent = txt;
        tileAdminBadge.textContent = txt;
        adminRequestsCounter.textContent = txt;
        
        if(count > 0) {
            sidebarAdminBadge.classList.remove('hidden');
            tileAdminBadge.classList.remove('hidden');
            adminRequestsCounter.classList.remove('hidden');
        } else {
            sidebarAdminBadge.classList.add('hidden');
            tileAdminBadge.classList.add('hidden');
            adminRequestsCounter.classList.add('hidden');
        }
    }

    function createPendingCard(p) {
        const card = document.createElement('div');
        card.className = 'employee-card pending';
        
        const initials = (p.full_name || p.email).substring(0,2).toUpperCase();
        
        // Role Select
        const roleSel = document.createElement('select');
        roleSel.innerHTML = `<option value="user">Mitarbeiter</option><option value="admin">Administrator</option>`;
        
        // Type Select
        const typeSel = document.createElement('select');
        typeSel.innerHTML = `<option value="fulltime">Vollzeit</option><option value="minijob">Minijob</option>`;

        card.innerHTML = `
            <div class="employee-avatar">${initials}</div>
            <div>
                <div class="employee-info-main">${p.full_name || '-'}</div>
                <div class="employee-info-sub">${p.email}</div>
                <div class="employee-info-sub" style="color:#e65100">Wartet auf Freigabe</div>
                <div class="employee-role-selector">
                    <label>Rolle:</label>
                </div>
            </div>
        `;
        
        card.querySelector('.employee-role-selector').appendChild(roleSel);
        
        const typeDiv = document.createElement('div');
        typeDiv.className = 'employee-role-selector';
        typeDiv.innerHTML = '<label>Art:</label>';
        typeDiv.appendChild(typeSel);
        
        // Hide Art if Admin
        roleSel.addEventListener('change', () => {
             typeSel.disabled = (roleSel.value === 'admin');
        });

        const actions = document.createElement('div');
        actions.className = 'employee-actions';
        
        const btnApprove = document.createElement('button');
        btnApprove.className = 'btn-small approve';
        btnApprove.textContent = 'Freigeben';
        btnApprove.onclick = () => approveUser(p.id, roleSel.value, typeSel.value);
        
        const btnOpen = document.createElement('button');
        btnOpen.className = 'btn-small primary';
        btnOpen.textContent = '√ñffnen';
        btnOpen.onclick = () => openEmployeeDetail(p);

        actions.appendChild(btnApprove);
        actions.appendChild(btnOpen);
        
        // Insert typeDiv before actions
        card.children[1].appendChild(typeDiv);
        card.children[1].appendChild(actions);

        return card;
    }

    function renderGroup(title, list) {
        if (list.length === 0) return;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'employee-category-wrapper';
        wrapper.innerHTML = `<h4 class="employee-category-heading">${title}</h4>`;
        
        const grid = document.createElement('div');
        grid.className = 'employee-grid';
        
        list.forEach(p => {
            const card = document.createElement('div');
            card.className = 'employee-card';
            if(p.role === 'admin') card.classList.add('admin');
            
            const initials = (p.full_name || p.email).substring(0,2).toUpperCase();
            
            // Edit Role
            const roleSel = document.createElement('select');
            roleSel.innerHTML = `<option value="user" ${p.role==='user'?'selected':''}>Mitarbeiter</option>
                                 <option value="admin" ${p.role==='admin'?'selected':''}>Administrator</option>`;
            
            // Edit Type (Neu hinzugef√ºgt)
            const typeSel = document.createElement('select');
            typeSel.innerHTML = `<option value="fulltime" ${p.employment_type==='fulltime'?'selected':''}>Vollzeit</option>
                                 <option value="minijob" ${p.employment_type==='minijob'?'selected':''}>Minijob</option>`;
            
            if(p.role === 'admin') typeSel.disabled = true;

            roleSel.addEventListener('change', () => {
                typeSel.disabled = (roleSel.value === 'admin');
            });
            
            // Actions
            const actions = document.createElement('div');
            actions.className = 'employee-actions';
            
            const btnSave = document.createElement('button');
            btnSave.className = 'btn-small grey';
            btnSave.textContent = 'Speichern'; // Umbenannt, da jetzt Rolle & Art gespeichert werden
            // Update Funktion angepasst
            btnSave.onclick = () => updateUserStatus(p.id, roleSel.value, typeSel.value);

            const btnOpen = document.createElement('button');
            btnOpen.className = 'btn-small primary';
            btnOpen.textContent = '√ñffnen';
            btnOpen.onclick = () => openEmployeeDetail(p);
            
            actions.appendChild(btnOpen);
            actions.appendChild(btnSave);

            card.innerHTML = `
                <div class="employee-avatar">${initials}</div>
                <div>
                    <div class="employee-info-main">${p.full_name || '-'}</div>
                    <div class="employee-info-sub">${p.email}</div>
                    <div class="employee-role-selector"><label>Rolle:</label></div>
                </div>
            `;
            
            card.querySelector('.employee-role-selector').appendChild(roleSel);
            
            // Type Selector Container
            const typeDiv = document.createElement('div');
            typeDiv.className = 'employee-role-selector';
            typeDiv.innerHTML = '<label>Art:</label>';
            typeDiv.appendChild(typeSel);
            
            card.children[1].appendChild(typeDiv);
            card.children[1].appendChild(actions); 
            
            grid.appendChild(card);
        });
        
        wrapper.appendChild(grid);
        approvedEmployeesContent.appendChild(wrapper);
    }

    async function approveUser(id, role, empType) {
        if(!confirm('Benutzer wirklich freigeben?')) return;
        
        const updates = {
            is_approved: true,
            approved_at: new Date(),
            approved_by: currentUser.id,
            role: role,
            employment_type: (role === 'admin') ? null : empType
        };

        const { error } = await supabaseClient.from('profiles').update(updates).eq('id', id);
        if(error) alert('Fehler: ' + error.message);
        else loadEmployeeGrid();
    }

    async function updateUserStatus(id, role, empType) {
        const updates = {
            role: role,
            employment_type: (role === 'admin') ? null : empType
        };

        const { error } = await supabaseClient.from('profiles').update(updates).eq('id', id);
        if(error) alert('Fehler: ' + error.message);
        else {
            alert('Daten aktualisiert');
            loadEmployeeGrid();
        }
    }
    
    // --- ADMIN UPLOAD ---
    
    function populateAdminUploadSelect(profiles) {
        adminUnterwUserSelect.innerHTML = '';
        profiles.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.full_name || p.email;
            adminUnterwUserSelect.appendChild(opt);
        });
    }

    adminUnterwScope.addEventListener('change', () => {
        if(adminUnterwScope.value === 'single') adminUnterwUserSelectWrapper.classList.remove('hidden');
        else adminUnterwUserSelectWrapper.classList.add('hidden');
    });

    adminUnterwUploadBtn.addEventListener('click', async () => {
        const file = adminUnterwInput.files[0];
        if (!file) return alert('Bitte Datei w√§hlen');
        
        adminUnterwMessage.textContent = 'Upload l√§uft...';
        
        try {
            const category = adminUploadCategory.value; 
            const scope = adminUnterwScope.value;
            
            // Filter Targets
            let targets = [];
            const approved = allProfilesCache.filter(p => p.is_approved);
            
            if (scope === 'all') targets = approved;
            else if (scope === 'fulltime') targets = approved.filter(p => p.employment_type === 'fulltime');
            else if (scope === 'minijob') targets = approved.filter(p => p.employment_type === 'minijob');
            else if (scope === 'single') {
                const uid = adminUnterwUserSelect.value;
                targets = approved.filter(p => p.id === uid);
            }

            if(targets.length === 0) throw new Error('Keine Mitarbeiter ausgew√§hlt.');

            // Upload Once
            const url = await uploadFileToStorage(file, `unterweisungen/admin`);
            
            // Insert Rows
            for (const t of targets) {
                const title = `${file.name} ‚Äì ${t.full_name}`;
                await insertDocumentRow(t.id, title, category, url);
            }
            
            adminUnterwMessage.textContent = `Erfolgreich an ${targets.length} Mitarbeiter verteilt.`;
            adminUnterwInput.value = '';

        } catch (e) {
            adminUnterwMessage.textContent = 'Fehler: ' + e.message;
        }
    });

    // --- ADMIN OVERVIEW (NEW UPLOADS) ---

    async function loadAdminDocumentOverviews() {
        const { data: docs, error } = await supabaseClient
            .from('documents')
            .select('*')
            .in('doc_type', ['stundenzettel', 'krankmeldung'])
            .order('created_at', { ascending: false });

        if(error) return;

        // Load Last Seen
        const lastTs = localStorage.getItem('bayrak_admin_last_opened_timesheets') || '1970-01-01';
        const lastSn = localStorage.getItem('bayrak_admin_last_opened_sicknotes') || '1970-01-01';

        // Filter Lists
        const tsDocs = docs.filter(d => d.doc_type === 'stundenzettel');
        const snDocs = docs.filter(d => d.doc_type === 'krankmeldung');

        // Count New
        const newTs = tsDocs.filter(d => new Date(d.created_at) > new Date(lastTs)).length;
        const newSn = snDocs.filter(d => new Date(d.created_at) > new Date(lastSn)).length;

        adminTimesheetsNewCount.textContent = newTs > 0 ? `${newTs} neue Uploads seit letztem Besuch` : 'Keine neuen Uploads.';
        adminSicknotesNewCount.textContent = newSn > 0 ? `${newSn} neue Uploads seit letztem Besuch` : 'Keine neuen Uploads.';

        renderAdminGroupedList(tsDocs, adminTimesheetsOverview);
        renderAdminGroupedList(snDocs, adminSicknotesOverview);

        // Update Last Seen
        localStorage.setItem('bayrak_admin_last_opened_timesheets', new Date().toISOString());
        localStorage.setItem('bayrak_admin_last_opened_sicknotes', new Date().toISOString());
    }

    function renderAdminGroupedList(docs, container) {
        container.innerHTML = '';
        if(docs.length === 0) {
            container.textContent = 'Keine Eintr√§ge.';
            return;
        }
        
        // Group by User -> Month
        const map = {};
        docs.forEach(d => {
            // Find name from cache
            const prof = allProfilesCache.find(p => p.id === d.user_id);
            const name = prof ? prof.full_name : 'Unbekannt';
            const date = new Date(d.created_at);
            const key = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}`;
            
            if(!map[name]) map[name] = {};
            if(!map[name][key]) map[name][key] = 0;
            map[name][key]++;
        });

        for (const [name, months] of Object.entries(map)) {
            const div = document.createElement('div');
            div.className = 'admin-overview-entry';
            
            let html = `<div class="admin-overview-name">${name}</div>`;
            for(const [m, count] of Object.entries(months)) {
                html += `<div class="admin-overview-details">‚Ä¢ ${m}: ${count} Datei(en)</div>`;
            }
            div.innerHTML = html;
            container.appendChild(div);
        }
    }
    
    // --- EMPLOYEE DETAIL ---
    
    async function openEmployeeDetail(p) {
        setActiveSection('section-employee-detail');
        employeeDetailInfoTitle.textContent = p.full_name || p.email;
        employeeDetailMeta.textContent = `E-Mail: ${p.email} | Status: ${p.is_approved ? 'Freigegeben' : 'Pending'}`;
        
        // Load Docs
        const { data: docs } = await supabaseClient
            .from('documents')
            .select('*')
            .eq('user_id', p.id)
            .order('created_at', { ascending: false });
            
        renderDocumentList(employeeDetailDocs, docs || []);
    }

    // --- SETTINGS ---

    function populateSettingsForm(profile, user) {
        settingsFirstName.value = profile.first_name || '';
        settingsLastName.value = profile.last_name || '';
        settingsEmail.value = user.email;
        settingsEmploymentType.value = profile.employment_type || 'fulltime';
    }

    settingsSaveProfile.addEventListener('click', async () => {
        const first = settingsFirstName.value;
        const last = settingsLastName.value;
        
        if (!first || !last) return alert('Bitte Namen ausf√ºllen');
        
        const updates = {
            first_name: first,
            last_name: last,
            full_name: `${first} ${last}`,
            employment_type: settingsEmploymentType.value
        };

        const { error } = await supabaseClient.from('profiles').update(updates).eq('id', currentUser.id);
        
        if (error) {
            settingsProfileMsg.textContent = 'Fehler: ' + error.message;
            settingsProfileMsg.style.color = 'red';
        } else {
            // Update Auth Meta
            await supabaseClient.auth.updateUser({ data: { full_name: updates.full_name } });
            
            settingsProfileMsg.textContent = 'Gespeichert.';
            settingsProfileMsg.style.color = 'green';
            userNameText.textContent = updates.full_name; 
        }
    });

    settingsChangePw.addEventListener('click', async () => {
        const cur = settingsCurrentPw.value;
        const n1 = settingsNewPw.value;
        const n2 = settingsNewPw2.value;

        if(!isStrongPassword(n1)) return alert('Passwort zu schwach (min 8, Gro√übuchstabe, Zahl/Sonderzeichen).');
        if(n1 !== n2) return alert('Neue Passw√∂rter stimmen nicht √ºberein.');

        // Re-Auth to verify current password
        const { error: signInError } = await supabaseClient.auth.signInWithPassword({
            email: currentUser.email,
            password: cur
        });

        if(signInError) {
            settingsPasswordMsg.textContent = 'Aktuelles Passwort falsch.';
            settingsPasswordMsg.style.color = 'red';
            return;
        }

        const { error: updateError } = await supabaseClient.auth.updateUser({ password: n1 });
        
        if(updateError) {
            settingsPasswordMsg.textContent = 'Fehler: ' + updateError.message;
        } else {
            settingsPasswordMsg.textContent = 'Passwort ge√§ndert.';
            settingsPasswordMsg.style.color = 'green';
            settingsCurrentPw.value = '';
            settingsNewPw.value = '';
            settingsNewPw2.value = '';
        }
    });

    // --- AUTH ACTIONS (EVENT LISTENERS) ---

    loginBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) showAuthError(error.message);
        else showPortal(data.user);
    });

    registerBtn.addEventListener('click', async () => {
        const email = regEmail.value;
        const pw = regPassword.value;
        const pw2 = regPassword2.value;
        const first = regFirstName.value;
        const last = regLastName.value;

        if (!first || !last) return showAuthError('Bitte Namen ausf√ºllen');
        if (pw !== pw2) return showAuthError('Passw√∂rter ungleich');
        if (!isStrongPassword(pw)) return showAuthError('Passwort zu schwach');

        const { error } = await supabaseClient.auth.signUp({
            email,
            password: pw,
            options: {
                data: {
                    first_name: first,
                    last_name: last,
                    full_name: `${first} ${last}`
                }
            }
        });

        if (error) showAuthError(error.message);
        else {
            showAuthSuccess('Registrierung erfolgreich! Bitte E-Mail best√§tigen.');
            setTimeout(() => {
                registerBox.classList.add('hidden');
                loginBox.classList.remove('hidden');
                clearAuthMessages();
            }, 3000);
        }
    });

    forgotPasswordBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        if (!email) return showAuthError('Bitte E-Mail eingeben f√ºr Reset');
        
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href // Redirect back here
        });
        
        if (error) showAuthError(error.message);
        else showAuthSuccess('Link gesendet.');
    });

    resetPasswordBtn.addEventListener('click', async () => {
        const pw = resetPasswordInput.value;
        if (pw !== resetPassword2Input.value) return alert('Ungleich');
        
        const { error } = await supabaseClient.auth.updateUser({ password: pw });
        if(error) alert(error.message);
        else {
            alert('Passwort ge√§ndert.');
            window.location.hash = ''; // Clear recovery token
            resetBox.classList.add('hidden');
            loginBox.classList.remove('hidden');
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        showLogin();
    });
    
    pendingLogoutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        showLogin();
    });

    showRegisterBtn.addEventListener('click', () => {
        loginBox.classList.add('hidden');
        registerBox.classList.remove('hidden');
        clearAuthMessages();
    });

    backToLoginBtn.addEventListener('click', () => {
        registerBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
        clearAuthMessages();
    });

    // --- INITIALIZATION ---

    async function init() {
        initNavigation();
        
        // Check for Recovery Hash
        if(window.location.hash.includes('type=recovery')) {
             authSection.classList.remove('hidden');
             loginBox.classList.add('hidden');
             resetBox.classList.remove('hidden');
             return; 
        }

        const { data } = await supabaseClient.auth.getSession();
        if (data.session) {
            showPortal(data.session.user);
        } else {
            showLogin();
        }
    }

    init();

</script>
</body>
</html>