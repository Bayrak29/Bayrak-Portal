<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bayrak Mitarbeiter-Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --blue-dark: #004b7a;
            --blue-light: #e7f2fb;
            --orange: #f57c00;
            --grey-bg: #f5f5f5;
            --card-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--grey-bg);
            color: #333;
        }

        /* TOP-LEISTE */
        header {
            background: var(--blue-dark);
            color: #fff;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .brand-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .brand-subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-user {
            font-size: 0.85rem;
            max-width: 220px;
        }

        .btn-top {
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            background: #c0392b;
            color: #fff;
        }

        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 10px 25px 10px;
        }

        /* AUTH-BEREICH */
        #auth-section {
            max-width: 460px;
            margin: 40px auto;
            background: #fff;
            padding: 20px 18px 22px 18px;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
        }

        #auth-section h2 {
            margin-top: 0;
        }

        #auth-section h3 {
            margin: 10px 0 4px 0;
            font-size: 1rem;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 7px 8px;
            margin-top: 3px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
        }

        .btn-primary,
        .btn-secondary {
            margin-top: 12px;
            padding: 8px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--blue-dark);
            color: #fff;
        }

        .btn-secondary {
            background: #777;
            color: #fff;
            margin-left: 6px;
        }

        .btn-link {
            background: transparent;
            border: none;
            color: var(--blue-dark);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 8px;
        }

        .info {
            font-size: 0.8rem;
            color: #555;
            margin-top: 8px;
        }

        .error {
            color: #b00020;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .success {
            color: #0a7a1b;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .separator-line {
            margin: 14px 0;
            border-top: 1px solid #eee;
        }

        /* PORTAL-LAYOUT (Sidebar + Inhalt) */
        #portal-section {
            background: transparent;
        }

        .portal-layout {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .portal-layout {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            padding: 14px 12px;
        }

        .sidebar-title {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .sidebar-user {
            font-size: 0.8rem;
            margin-bottom: 12px;
            color: #555;
        }

        .sidebar-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-list li {
            padding: 7px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-list li span.icon {
            width: 18px;
            text-align: center;
        }

        .sidebar-list li.active,
        .sidebar-list li:hover {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .sidebar-admin {
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #777;
        }

        .request-badge {
            display: inline-block;
            background: #e53935;
            color: #fff;
            border-radius: 999px;
            font-size: 0.7rem;
            padding: 0 6px;
            margin-left: 4px;
            min-width: 16px;
            text-align: center;
        }

        /* Hauptbereich */
        .main-content {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            padding: 16px 16px 18px 16px;
        }

        .portal-greeting {
            margin-bottom: 14px;
        }

        .portal-greeting h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .portal-greeting p {
            margin: 4px 0 0 0;
            font-size: 0.85rem;
            color: #666;
        }

        .role-badge {
            display: inline-block;
            margin-left: 6px;
            font-size: 0.75rem;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* SECTIONS + DASHBOARD-TILES */
        .portal-section-content {
            margin-top: 10px;
        }

        .tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 6px;
        }

        .tile-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }

        .tile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            background: #fdfdfd;
        }

        .tile-card.active {
            border: 2px solid var(--orange);
        }

        .tile-icon {
            font-size: 1.6rem;
            margin-bottom: 6px;
            color: var(--orange);
        }

        .tile-title {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .tile-sub {
            font-size: 0.8rem;
            color: #777;
        }

        h3.section-title {
            margin: 12px 0 6px 0;
            font-size: 1rem;
        }

        /* DOKUMENTE (Liste) */
        .document-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0 0;
        }

        .document-item {
            background: #ffffff;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        .document-item-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .document-item-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .document-item a {
            background: var(--blue-dark);
            color: #fff;
            padding: 6px 9px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* ADMIN: MITARBEITER-KACHELN */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .employee-card {
            border-radius: 6px;
            padding: 10px 10px 12px 10px;
            box-shadow: var(--card-shadow);
            background: #fafafa;
            display: grid;
            grid-template-columns: 48px minmax(0, 1fr);
            gap: 8px;
            font-size: 0.85rem;
        }

        .employee-card.pending {
            border: 2px solid #ff9800;
            background: #fff7e6;
        }

        .employee-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #555;
            border: 2px solid #4caf50;
        }

        .employee-info-main {
            font-weight: 600;
        }

        .employee-info-sub {
            font-size: 0.8rem;
            color: #666;
        }

        .employee-role {
            margin-top: 4px;
        }

        .employee-role select {
            font-size: 0.8rem;
            padding: 3px 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .employee-actions {
            margin-top: 6px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 4px 6px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-small.primary {
            background: var(--blue-dark);
            color: #fff;
        }

        .btn-small.grey {
            background: #777;
            color: #fff;
        }

        .btn-small.approve {
            background: #2e7d32;
            color: #fff;
        }

        .admin-message {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .employee-category-wrapper {
            margin-bottom: 16px;
        }

        .employee-category-heading {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: #444;
        }

        /* SETTINGS */
        .settings-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .settings-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 12px 12px 14px 12px;
            box-shadow: var(--card-shadow);
        }

        .settings-card h4 {
            margin: 0 0 6px 0;
            font-size: 0.95rem;
        }

        .settings-card p {
            margin: 4px 0 8px 0;
            font-size: 0.8rem;
            color: #666;
        }

        .settings-inline {
            display: flex;
            gap: 8px;
        }

        .settings-inline > div {
            flex: 1;
        }

        .settings-message {
            margin-top: 6px;
            font-size: 0.8rem;
        }

        /* PENDING-SECTION (nicht freigegeben) */
        #pending-section {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            padding: 20px 18px 22px 18px;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
        }

        #pending-section h2 {
            margin-top: 0;
        }

        @media (max-width: 600px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .top-right {
                align-self: stretch;
                justify-content: space-between;
            }
            .top-user {
                max-width: none;
            }

            .settings-inline {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="brand-logo">B</div>
        <div>
            <div class="brand-title">Bayrak Mitarbeiter-Portal</div>
            <div class="brand-subtitle">Interne Web-App ¬∑ Testversion</div>
        </div>
    </div>
    <div class="top-right">
        <div class="top-user" id="top-user-text"></div>
        <button id="logout-btn" class="btn-top hidden">Abmelden</button>
    </div>
</header>

<main>
    <!-- LOGIN / REGISTRIERUNG / PASSWORT-RESET -->
    <section id="auth-section">
        <h2>Anmeldung</h2>
        <div id="auth-error" class="error hidden"></div>
        <div id="auth-success" class="success hidden"></div>

        <!-- Login-Box -->
        <div id="login-box">
            <h3>Einloggen</h3>
            <label for="email">E-Mail</label>
            <input type="email" id="email" placeholder="deine@email.de">

            <label for="password">Passwort</label>
            <input type="password" id="password" placeholder="Passwort">

            <button id="login-btn" class="btn-primary">Einloggen</button>

            <button id="forgot-password-btn" class="btn-link" type="button">Passwort vergessen?</button>

            <div class="separator-line"></div>

            <p class="info">Sie haben noch kein Konto?</p>
            <button id="show-register-btn" class="btn-secondary">Neu anmelden</button>
        </div>

        <!-- Registrierungs-Box -->
        <div id="register-box" class="hidden">
            <h3>Neu anmelden</h3>

            <label for="reg-first-name">Vorname</label>
            <input type="text" id="reg-first-name" placeholder="Vorname">

            <label for="reg-last-name">Nachname</label>
            <input type="text" id="reg-last-name" placeholder="Nachname">

            <label for="reg-email">E-Mail</label>
            <input type="email" id="reg-email" placeholder="E-Mail">

            <label for="reg-password">Passwort</label>
            <input type="password" id="reg-password" placeholder="Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen">

            <label for="reg-password2">Passwort wiederholen</label>
            <input type="password" id="reg-password2" placeholder="Passwort best√§tigen">

            <button id="register-btn" class="btn-primary">Registrierung abschlie√üen</button>
            <button id="back-to-login-btn" class="btn-secondary">Zur√ºck zum Login</button>

            <p class="info">
                Nach der Registrierung erhalten Sie eine E-Mail zur Best√§tigung Ihrer Adresse.<br>
                Anschlie√üend muss ein Administrator Ihren Zugang freigeben, bevor Sie das Portal nutzen k√∂nnen.
            </p>
        </div>

        <!-- Passwort-Reset-Box (f√ºr Recovery-Link) -->
        <div id="reset-box" class="hidden">
            <h3>Neues Passwort setzen</h3>
            <p class="info">
                Sie haben einen Link ‚ÄûPasswort zur√ºcksetzen‚Äú verwendet. Bitte w√§hlen Sie jetzt ein neues Passwort.
            </p>

            <label for="reset-password">Neues Passwort</label>
            <input type="password" id="reset-password" placeholder="Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen">

            <label for="reset-password2">Passwort wiederholen</label>
            <input type="password" id="reset-password2" placeholder="Neues Passwort best√§tigen">

            <button id="reset-password-btn" class="btn-primary">Passwort speichern</button>
        </div>
    </section>

    <!-- PENDING-SECTION: Benutzer ist registriert, aber noch nicht freigegeben -->
    <section id="pending-section" class="hidden">
        <h2>Registrierung ausstehend</h2>
        <p id="pending-message" class="info"></p>
        <p class="info">
            Ihre Registrierung wurde erfolgreich gespeichert und Ihre E-Mail-Adresse ist best√§tigt.<br>
            Ein Administrator wird Ihren Zugang pr√ºfen und freigeben. Sobald dies erfolgt ist, k√∂nnen Sie sich normal einloggen.
        </p>
        <button id="pending-logout-btn" class="btn-primary">Abmelden</button>
    </section>

    <!-- PORTAL NACH LOGIN (freigegeben) -->
    <section id="portal-section" class="hidden">
        <div class="portal-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-title">Mitarbeiterportal</div>
                <div class="sidebar-user" id="sidebar-user-role"></div>

                <ul class="sidebar-list" id="sidebar-nav">
                    <li data-target="section-dashboard" class="active">
                        <span class="icon">üè†</span> <span>Startseite</span>
                    </li>
                    <li data-target="section-documents">
                        <span class="icon">üìÑ</span> <span>Unterweisungen / Dokumente</span>
                    </li>
                    <li data-target="section-timesheet">
                        <span class="icon">üïí</span> <span>Stundenzettel</span>
                    </li>
                    <li data-target="section-arbeitsvertrag">
                        <span class="icon">üìÉ</span> <span>Arbeitsvertrag</span>
                    </li>
                    <li data-target="section-settings">
                        <span class="icon">‚öôÔ∏è</span> <span>Einstellungen</span>
                    </li>
                    <li data-target="section-admin" id="sidebar-admin-link" class="hidden">
                        <span class="icon">üõ†</span> <span>Admin ¬∑ Mitarbeiter</span>
                        <span id="sidebar-admin-badge" class="request-badge hidden"></span>
                    </li>
                </ul>

                <div id="sidebar-admin-label" class="sidebar-admin hidden">
                    Sie sind <strong>Administrator</strong> und k√∂nnen Mitarbeiter &amp; Rollen verwalten.
                </div>
            </aside>

            <!-- Inhalt -->
            <div class="main-content">
                <div class="portal-greeting">
                    <h2>
                        Guten Tag,
                        <span id="user-name-text">Mitarbeiter</span>
                        <span id="role-badge" class="role-badge hidden"></span>
                    </h2>
                    <p>Willkommen im Bayrak Mitarbeiter-Portal. W√§hlen Sie eine Kachel oder einen Men√ºpunkt.</p>
                </div>

                <!-- DASHBOARD -->
                <div id="section-dashboard" class="portal-section-content">
                    <div class="tile-grid">
                        <div class="tile-card active" data-target="section-documents">
                            <div class="tile-icon">üìÑ</div>
                            <div class="tile-title">Unterweisungen</div>
                            <div class="tile-sub">Dokumente &amp; Infos</div>
                        </div>
                        <div class="tile-card" data-target="section-timesheet">
                            <div class="tile-icon">üïí</div>
                            <div class="tile-title">Stundenzettel</div>
                            <div class="tile-sub">Arbeitszeiten erfassen</div>
                        </div>
                        <div class="tile-card" data-target="section-arbeitsvertrag">
                            <div class="tile-icon">üìÉ</div>
                            <div class="tile-title">Arbeitsvertrag</div>
                            <div class="tile-sub">Vertr√§ge &amp; Bescheinigungen</div>
                        </div>
                        <div class="tile-card" data-target="section-settings">
                            <div class="tile-icon">‚öôÔ∏è</div>
                            <div class="tile-title">Einstellungen</div>
                            <div class="tile-sub">Profil &amp; Passwort</div>
                        </div>
                        <div id="tile-admin" class="tile-card hidden" data-target="section-admin">
                            <div class="tile-icon">üë•</div>
                            <div class="tile-title">
                                Mitarbeiter (Admin)
                                <span id="tile-admin-badge" class="request-badge hidden"></span>
                            </div>
                            <div class="tile-sub">√úbersicht &amp; Rollen</div>
                        </div>
                    </div>
                </div>

                <!-- UNTERWEISUNGEN / DOKUMENTE -->
                <div id="section-documents" class="portal-section-content hidden">
                    <h3 class="section-title">Unterweisungen / Dokumente</h3>
                    <p class="info">
                        Hier sehen Sie alle Dokumente, die Ihnen pers√∂nlich zugeordnet wurden (Unterweisungen, Vertr√§ge, Informationen).
                    </p>
                    <div id="documents-message" class="info"></div>
                    <ul id="documents-list" class="document-list"></ul>
                </div>

                <!-- STUNDENZETTEL (Platzhalter) -->
                <div id="section-timesheet" class="portal-section-content hidden">
                    <h3 class="section-title">Stundenzettel</h3>
                    <p class="info">
                        Hier wird sp√§ter die Stundenzettel-Funktion integriert (mit Speicherung in Supabase).
                        <br><strong>Aktuell ist dies nur ein Platzhalter.</strong>
                    </p>
                </div>

                <!-- ARBEITSVERTRAG (Platzhalter) -->
                <div id="section-arbeitsvertrag" class="portal-section-content hidden">
                    <h3 class="section-title">Arbeitsvertrag / Dokumente</h3>
                    <p class="info">
                        In diesem Bereich k√∂nnen sp√§ter Arbeitsvertr√§ge, Zusatzvereinbarungen und wichtige Bescheinigungen
                        pro Mitarbeiter hinterlegt und heruntergeladen werden.
                    </p>
                </div>

                <!-- EINSTELLUNGEN: PROFIL & PASSWORT -->
                <div id="section-settings" class="portal-section-content hidden">
                    <h3 class="section-title">Einstellungen</h3>
                    <p class="info">
                        Hier k√∂nnen Sie Ihre Profildaten bearbeiten und Ihr Passwort √§ndern.
                    </p>

                    <div class="settings-grid">
                        <!-- Profildaten -->
                        <div class="settings-card">
                            <h4>Profildaten</h4>
                            <p>Aktualisieren Sie hier Ihren Namen. Die E-Mail-Adresse ist aktuell nur informativ.</p>

                            <div class="settings-inline">
                                <div>
                                    <label for="settings-first-name">Vorname</label>
                                    <input type="text" id="settings-first-name" placeholder="Vorname">
                                </div>
                                <div>
                                    <label for="settings-last-name">Nachname</label>
                                    <input type="text" id="settings-last-name" placeholder="Nachname">
                                </div>
                            </div>

                            <label for="settings-email">E-Mail</label>
                            <input type="email" id="settings-email" disabled>

                            <button id="settings-save-profile" class="btn-primary">Profil speichern</button>
                            <div id="settings-profile-msg" class="settings-message"></div>
                        </div>

                        <!-- Passwort √§ndern -->
                        <div class="settings-card">
                            <h4>Passwort √§ndern</h4>
                            <p>Das neue Passwort muss mindestens 8 Zeichen, einen Gro√übuchstaben und eine Zahl oder ein Sonderzeichen enthalten.</p>

                            <label for="settings-current-password">Aktuelles Passwort</label>
                            <input type="password" id="settings-current-password" placeholder="Aktuelles Passwort">

                            <label for="settings-new-password">Neues Passwort</label>
                            <input type="password" id="settings-new-password" placeholder="Neues Passwort">

                            <label for="settings-new-password2">Neues Passwort wiederholen</label>
                            <input type="password" id="settings-new-password2" placeholder="Neues Passwort best√§tigen">

                            <button id="settings-change-password" class="btn-primary">Passwort √§ndern</button>
                            <div id="settings-password-msg" class="settings-message"></div>
                        </div>
                    </div>
                </div>

                <!-- ADMIN: MITARBEITER-KACHELN -->
                <div id="section-admin" class="portal-section-content hidden">
                    <h3 class="section-title">
                        Admin ¬∑ Mitarbeiter√ºbersicht
                        <span id="admin-requests-counter" class="request-badge hidden"></span>
                    </h3>
                    <p class="info">
                        Hier sehen Sie alle im System angelegten Mitarbeiter. Offene Registrierungs-Anfragen k√∂nnen Sie
                        im Bereich ‚ÄûOffene Anfragen‚Äú freigeben.
                    </p>

                    <div id="pending-requests-box" class="hidden">
                        <h4>Offene Anfragen (noch nicht freigegeben)</h4>
                        <div id="pending-employee-grid" class="employee-grid"></div>
                    </div>

                    <h4 style="margin-top:14px;">Alle Mitarbeiter</h4>
                    <div id="employee-grid"></div>

                    <div class="admin-message" id="admin-message"></div>
                </div>

                <!-- ADMIN: MITARBEITER-DETAILANSICHT -->
                <div id="section-employee-detail" class="portal-section-content hidden">
                    <h3 class="section-title">Mitarbeiter-Ansicht</h3>
                    <button id="employee-detail-back" class="btn-secondary">‚Üê Zur√ºck zur Mitarbeiter√ºbersicht</button>
                    <div id="employee-detail-info" class="info" style="margin-top:10px;"></div>

                    <h4 style="margin-top:14px;">Dokumente dieses Mitarbeiters</h4>
                    <div id="employee-detail-docs-message" class="info"></div>
                    <ul id="employee-detail-docs" class="document-list"></ul>

                    <p class="info">
                        (Sie sehen hier die Dokumente aus Sicht des Mitarbeiters. Weitere Bereiche wie Stundenzettel
                        und Arbeitsvertrag k√∂nnen wir sp√§ter erg√§nzen.)
                    </p>
                </div>
            </div>
        </div>
    </section>
</main>

<script type="module">
    // SUPABASE-DATEN
    const SUPABASE_URL = 'https://njjnyodpwpkpjdjxbmvo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qam55b2Rwd3BrcGpkanhibXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTg5MDQsImV4cCI6MjA3OTczNDkwNH0.aHBJ_g1zHZlWjceUFas_v2lYfrcjv8PuhPEAFpGj3_E';

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM-REFERENZEN
    const authSection      = document.getElementById('auth-section');
    const portalSection    = document.getElementById('portal-section');
    const pendingSection   = document.getElementById('pending-section');

    const authError        = document.getElementById('auth-error');
    const authSuccess      = document.getElementById('auth-success');

    const loginBox         = document.getElementById('login-box');
    const registerBox      = document.getElementById('register-box');
    const resetBox         = document.getElementById('reset-box');

    const emailInput       = document.getElementById('email');
    const passwordInput    = document.getElementById('password');
    const loginBtn         = document.getElementById('login-btn');

    const forgotPasswordBtn = document.getElementById('forgot-password-btn');

    const showRegisterBtn  = document.getElementById('show-register-btn');
    const registerBtn      = document.getElementById('register-btn');
    const backToLoginBtn   = document.getElementById('back-to-login-btn');

    const regFirstName     = document.getElementById('reg-first-name');
    const regLastName      = document.getElementById('reg-last-name');
    const regEmail         = document.getElementById('reg-email');
    const regPassword      = document.getElementById('reg-password');
    const regPassword2     = document.getElementById('reg-password2');

    const resetPasswordInput  = document.getElementById('reset-password');
    const resetPassword2Input = document.getElementById('reset-password2');
    const resetPasswordBtn    = document.getElementById('reset-password-btn');

    const logoutBtn        = document.getElementById('logout-btn');
    const pendingLogoutBtn = document.getElementById('pending-logout-btn');
    const topUserText      = document.getElementById('top-user-text');
    const pendingMessage   = document.getElementById('pending-message');

    const userNameText     = document.getElementById('user-name-text');
    const roleBadge        = document.getElementById('role-badge');

    const sidebarUserRole  = document.getElementById('sidebar-user-role');
    const sidebarNav       = document.getElementById('sidebar-nav');
    const sidebarAdminLabel= document.getElementById('sidebar-admin-label');
    const sidebarAdminLink = document.getElementById('sidebar-admin-link');
    const sidebarAdminBadge= document.getElementById('sidebar-admin-badge');

    const tileAdmin        = document.getElementById('tile-admin');
    const tileAdminBadge   = document.getElementById('tile-admin-badge');

    const documentsMessage = document.getElementById('documents-message');
    const documentsList    = document.getElementById('documents-list');

    const employeeGrid     = document.getElementById('employee-grid');
    const pendingEmployeeGrid = document.getElementById('pending-employee-grid');
    const pendingRequestsBox  = document.getElementById('pending-requests-box');
    const adminMessage     = document.getElementById('admin-message');
    const adminRequestsCounter = document.getElementById('admin-requests-counter');

    const employeeDetailSection      = document.getElementById('section-employee-detail');
    const employeeDetailBackBtn      = document.getElementById('employee-detail-back');
    const employeeDetailInfo         = document.getElementById('employee-detail-info');
    const employeeDetailDocs         = document.getElementById('employee-detail-docs');
    const employeeDetailDocsMessage  = document.getElementById('employee-detail-docs-message');

    // SETTINGS DOM
    const settingsFirstName     = document.getElementById('settings-first-name');
    const settingsLastName      = document.getElementById('settings-last-name');
    const settingsEmail         = document.getElementById('settings-email');
    const settingsSaveProfile   = document.getElementById('settings-save-profile');
    const settingsProfileMsg    = document.getElementById('settings-profile-msg');

    const settingsCurrentPw     = document.getElementById('settings-current-password');
    const settingsNewPw         = document.getElementById('settings-new-password');
    const settingsNewPw2        = document.getElementById('settings-new-password2');
    const settingsChangePw      = document.getElementById('settings-change-password');
    const settingsPasswordMsg   = document.getElementById('settings-password-msg');

    let currentUser   = null;
    let currentProfile= null;
    let selectedEmployee = null;

    // Passwort-Policy: min. 8, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen
    function isStrongPassword(pw) {
        if (!pw || pw.length < 8) return false;
        const hasUpper = /[A-Z√Ñ√ñ√ú]/.test(pw);
        const hasDigitOrSpecial = /[0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/.test(pw);
        return hasUpper && hasDigitOrSpecial;
    }

    function showAuthError(msg) {
        authError.textContent = msg;
        authError.classList.remove('hidden');
        authSuccess.classList.add('hidden');
    }

    function showAuthSuccess(msg) {
        authSuccess.textContent = msg;
        authSuccess.classList.remove('hidden');
        authError.classList.add('hidden');
    }

    function clearAuthMessages() {
        authError.classList.add('hidden');
        authSuccess.classList.add('hidden');
    }

    function setActiveSection(targetId) {
        const allSections = [
            'section-dashboard',
            'section-documents',
            'section-timesheet',
            'section-arbeitsvertrag',
            'section-settings',
            'section-admin',
            'section-employee-detail'
        ];
        allSections.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (id === targetId) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });

        // Sidebar
        const items = sidebarNav.querySelectorAll('li');
        items.forEach(li => {
            const t = li.getAttribute('data-target');
            if (t === targetId) li.classList.add('active');
            else li.classList.remove('active');
        });

        // Tiles
        document.querySelectorAll('.tile-card').forEach(tile => {
            const t = tile.getAttribute('data-target');
            if (t === targetId) tile.classList.add('active');
            else tile.classList.remove('active');
        });
    }

    function initNavigation() {
        // Sidebar
        sidebarNav.querySelectorAll('li').forEach(li => {
            li.addEventListener('click', () => {
                const target = li.getAttribute('data-target');
                if (target) setActiveSection(target);
            });
        });

        // Dashboard-Kacheln
        document.querySelectorAll('.tile-card').forEach(tile => {
            tile.addEventListener('click', () => {
                const target = tile.getAttribute('data-target');
                if (target) setActiveSection(target);
            });
        });

        // Startansicht: Dashboard
        setActiveSection('section-dashboard');
    }

    function toggleToRegister() {
        clearAuthMessages();
        loginBox.classList.add('hidden');
        resetBox.classList.add('hidden');
        registerBox.classList.remove('hidden');
    }

    function toggleToLogin() {
        clearAuthMessages();
        registerBox.classList.add('hidden');
        resetBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
    }

    showRegisterBtn.addEventListener('click', toggleToRegister);
    backToLoginBtn.addEventListener('click', toggleToLogin);

    employeeDetailBackBtn.addEventListener('click', () => {
        selectedEmployee = null;
        setActiveSection('section-admin');
    });

    function setSettingsProfileMessage(msg, type = 'info') {
        settingsProfileMsg.textContent = msg || '';
        settingsProfileMsg.classList.remove('error', 'success');
        if (!msg) return;
        if (type === 'error') settingsProfileMsg.classList.add('error');
        if (type === 'success') settingsProfileMsg.classList.add('success');
    }

    function setSettingsPasswordMessage(msg, type = 'info') {
        settingsPasswordMsg.textContent = msg || '';
        settingsPasswordMsg.classList.remove('error', 'success');
        if (!msg) return;
        if (type === 'error') settingsPasswordMsg.classList.add('error');
        if (type === 'success') settingsPasswordMsg.classList.add('success');
    }

    async function loadProfile(user) {
        const { data, error } = await supabase
            .from('profiles')
            .select('full_name, role, email, is_approved, first_name, last_name, employment_type')
            .eq('id', user.id)
            .single();

        if (error) {
            console.warn('Profil konnte nicht geladen werden:', error.message);
            return {
                full_name: user.email,
                role: 'user',
                email: user.email,
                is_approved: false
            };
        }
        return data;
    }

    function populateSettingsForm(profile, user) {
        settingsFirstName.value = profile.first_name || '';
        settingsLastName.value  = profile.last_name || '';
        settingsEmail.value     = profile.email || user.email || '';
        setSettingsProfileMessage('');
        setSettingsPasswordMessage('');
        settingsCurrentPw.value = '';
        settingsNewPw.value     = '';
        settingsNewPw2.value    = '';
    }

    async function loadDocumentsForUser(user) {
        documentsMessage.textContent = '';
        documentsList.innerHTML = '';

        const { data, error } = await supabase
            .from('documents')
            .select('id, title, file_url, doc_type, created_at')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

        if (error) {
            documentsMessage.textContent = 'Fehler beim Laden der Dokumente: ' + error.message;
            return;
        }

        if (!data || data.length === 0) {
            documentsMessage.textContent = 'Es sind aktuell keine Dokumente f√ºr Sie hinterlegt.';
            return;
        }

        data.forEach(doc => {
            const li = document.createElement('li');
            li.className = 'document-item';

            const infoDiv = document.createElement('div');
            const titleEl = document.createElement('div');
            titleEl.className = 'document-item-title';
            titleEl.textContent = doc.title || 'Dokument';

            const metaEl = document.createElement('div');
            metaEl.className = 'document-item-meta';
            const parts = [];
            if (doc.doc_type) parts.push(doc.doc_type);
            if (doc.created_at) {
                try {
                    const d = new Date(doc.created_at);
                    parts.push(d.toLocaleDateString('de-DE'));
                } catch {}
            }
            metaEl.textContent = parts.join(' ‚Ä¢ ');

            infoDiv.appendChild(titleEl);
            if (parts.length > 0) infoDiv.appendChild(metaEl);

            const link = document.createElement('a');
            link.href = doc.file_url || '#';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = '√ñffnen';

            li.appendChild(infoDiv);
            li.appendChild(link);

            documentsList.appendChild(li);
        });
    }

    function updatePendingBadges(count) {
        const badges = [sidebarAdminBadge, tileAdminBadge, adminRequestsCounter];
        badges.forEach(b => {
            if (!b) return;
            if (count > 0) {
                b.textContent = String(count);
                b.classList.remove('hidden');
            } else {
                b.classList.add('hidden');
            }
        });
    }

    async function loadEmployeeDocumentsForAdmin(profileRow) {
        employeeDetailDocs.innerHTML = '';
        employeeDetailDocsMessage.textContent = '';

        const { data, error } = await supabase
            .from('documents')
            .select('id, title, file_url, doc_type, created_at')
            .eq('user_id', profileRow.id)
            .order('created_at', { ascending: false });

        if (error) {
            employeeDetailDocsMessage.textContent = 'Fehler beim Laden der Dokumente: ' + error.message;
            return;
        }

        if (!data || data.length === 0) {
            employeeDetailDocsMessage.textContent = 'Keine Dokumente f√ºr diesen Mitarbeiter vorhanden.';
            return;
        }

        data.forEach(doc => {
            const li = document.createElement('li');
            li.className = 'document-item';

            const infoDiv = document.createElement('div');
            const titleEl = document.createElement('div');
            titleEl.className = 'document-item-title';
            titleEl.textContent = doc.title || 'Dokument';

            const metaEl = document.createElement('div');
            metaEl.className = 'document-item-meta';
            const parts = [];
            if (doc.doc_type) parts.push(doc.doc_type);
            if (doc.created_at) {
                try {
                    const d = new Date(doc.created_at);
                    parts.push(d.toLocaleDateString('de-DE'));
                } catch {}
            }
            metaEl.textContent = parts.join(' ‚Ä¢ ');

            infoDiv.appendChild(titleEl);
            if (parts.length > 0) infoDiv.appendChild(metaEl);

            const link = document.createElement('a');
            link.href = doc.file_url || '#';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = '√ñffnen';

            li.appendChild(infoDiv);
            li.appendChild(link);

            employeeDetailDocs.appendChild(li);
        });
    }

    function describeEmploymentType(p) {
        if (p.role === 'admin') return 'Administrator';
        if (p.employment_type === 'fulltime') return 'Vollzeit-Mitarbeiter';
        if (p.employment_type === 'minijob') return 'Minijob-Mitarbeiter';
        return 'Mitarbeiter (ohne Kategorie)';
    }

    async function openEmployeeDetail(profileRow) {
        if (!currentProfile || currentProfile.role !== 'admin') return;
        selectedEmployee = profileRow;

        const typeText = describeEmploymentType(profileRow);
        const email = profileRow.email || '-';

        employeeDetailInfo.textContent =
            `${profileRow.full_name || email} ¬∑ Rolle: ${profileRow.role} ¬∑ Art: ${typeText} ¬∑ E-Mail: ${email}`;

        await loadEmployeeDocumentsForAdmin(profileRow);

        setActiveSection('section-employee-detail');
    }

    async function loadEmployeeGrid() {
        if (!currentProfile || currentProfile.role !== 'admin') {
            adminMessage.textContent = 'Keine Admin-Berechtigung.';
            employeeGrid.innerHTML = '';
            pendingEmployeeGrid.innerHTML = '';
            pendingRequestsBox.classList.add('hidden');
            updatePendingBadges(0);
            return;
        }

        adminMessage.textContent = 'Lade Mitarbeiter...';
        employeeGrid.innerHTML = '';
        pendingEmployeeGrid.innerHTML = '';

        const { data, error } = await supabase
            .from('profiles')
            .select('id, full_name, email, role, is_approved, employment_type')
            .order('full_name', { ascending: true });

        if (error) {
            adminMessage.textContent = 'Fehler beim Laden der Mitarbeiter: ' + error.message;
            updatePendingBadges(0);
            return;
        }

        const pending = data.filter(p => !p.is_approved);
        updatePendingBadges(pending.length);

        if (pending.length > 0) {
            pendingRequestsBox.classList.remove('hidden');
        } else {
            pendingRequestsBox.classList.add('hidden');
        }

        // Pending-Karten (mit Rollen- und Besch√§ftigungsart-Wahl)
        pending.forEach(p => {
            const card = document.createElement('div');
            card.className = 'employee-card pending';

            const avatar = document.createElement('div');
            avatar.className = 'employee-avatar';
            const initials = (p.full_name || p.email || '?')
                .split(' ')
                .map(x => x.trim()[0])
                .filter(Boolean)
                .slice(0,2)
                .join('')
                .toUpperCase();
            avatar.textContent = initials || '?';

            const infoCol = document.createElement('div');

            const nameEl = document.createElement('div');
            nameEl.className = 'employee-info-main';
            nameEl.textContent = p.full_name || '(kein Name)';

            const emailEl = document.createElement('div');
            emailEl.className = 'employee-info-sub';
            emailEl.textContent = p.email || '';

            const infoPending = document.createElement('div');
            infoPending.className = 'employee-info-sub';
            infoPending.textContent = 'Status: wartet auf Freigabe';

            const roleRow = document.createElement('div');
            roleRow.className = 'employee-role';
            const roleLabel = document.createElement('span');
            roleLabel.textContent = 'Rolle bei Freigabe: ';
            const roleSelect = document.createElement('select');
            const optUser = document.createElement('option');
            optUser.value = 'user';
            optUser.textContent = 'Mitarbeiter';
            const optAdmin = document.createElement('option');
            optAdmin.value = 'admin';
            optAdmin.textContent = 'Administrator';
            roleSelect.appendChild(optUser);
            roleSelect.appendChild(optAdmin);
            roleSelect.value = p.role || 'user';
            roleRow.appendChild(roleLabel);
            roleRow.appendChild(roleSelect);

            // Besch√§ftigungsart nur f√ºr Nicht-Admins relevant
            const typeRow = document.createElement('div');
            typeRow.className = 'employee-role';
            const typeLabel = document.createElement('span');
            typeLabel.textContent = 'Besch√§ftigungsart: ';
            const typeSelect = document.createElement('select');
            const optFull = document.createElement('option');
            optFull.value = 'fulltime';
            optFull.textContent = 'Vollzeit';
            const optMini = document.createElement('option');
            optMini.value = 'minijob';
            optMini.textContent = 'Minijob';
            typeSelect.appendChild(optFull);
            typeSelect.appendChild(optMini);
            typeSelect.value = p.employment_type || 'fulltime';
            typeRow.appendChild(typeLabel);
            typeRow.appendChild(typeSelect);

            const actions = document.createElement('div');
            actions.className = 'employee-actions';

            const btnApprove = document.createElement('button');
            btnApprove.className = 'btn-small approve';
            btnApprove.textContent = 'Freigeben';
            btnApprove.addEventListener('click', async () => {
                const employmentType = (roleSelect.value === 'admin') ? null : typeSelect.value;
                await approveUser(p, roleSelect.value, employmentType);
            });

            const btnOpen = document.createElement('button');
            btnOpen.className = 'btn-small primary';
            btnOpen.textContent = 'Mitarbeiter √∂ffnen';
            btnOpen.addEventListener('click', () => {
                openEmployeeDetail(p);
            });

            actions.appendChild(btnApprove);
            actions.appendChild(btnOpen);

            infoCol.appendChild(nameEl);
            infoCol.appendChild(emailEl);
            infoCol.appendChild(infoPending);
            infoCol.appendChild(roleRow);
            infoCol.appendChild(typeRow);
            infoCol.appendChild(actions);

            card.appendChild(avatar);
            card.appendChild(infoCol);

            pendingEmployeeGrid.appendChild(card);
        });

        // ========== Alle Mitarbeiter gruppiert anzeigen ==========
        const admins   = data.filter(p => p.role === 'admin');
        const fulltime = data.filter(p => p.role !== 'admin' && p.employment_type === 'fulltime');
        const minijob  = data.filter(p => p.role !== 'admin' && p.employment_type === 'minijob');
        const others   = data.filter(p =>
            p.role !== 'admin' &&
            (!p.employment_type || (p.employment_type !== 'fulltime' && p.employment_type !== 'minijob'))
        );

        employeeGrid.innerHTML = '';

        function createCategoryBlock(titleText, list) {
            if (!list || list.length === 0) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'employee-category-wrapper';

            const heading = document.createElement('div');
            heading.className = 'employee-category-heading';
            heading.textContent = titleText;

            const grid = document.createElement('div');
            grid.className = 'employee-grid';

            list.forEach(p => {
                const card = buildEmployeeCard(p);
                grid.appendChild(card);
            });

            wrapper.appendChild(heading);
            wrapper.appendChild(grid);
            employeeGrid.appendChild(wrapper);
        }

        function buildEmployeeCard(p) {
            const card = document.createElement('div');
            card.className = 'employee-card';

            const avatar = document.createElement('div');
            avatar.className = 'employee-avatar';
            const initials = (p.full_name || p.email || '?')
                .split(' ')
                .map(x => x.trim()[0])
                .filter(Boolean)
                .slice(0,2)
                .join('')
                .toUpperCase();
            avatar.textContent = initials || '?';

            const infoCol = document.createElement('div');

            const nameEl = document.createElement('div');
            nameEl.className = 'employee-info-main';
            nameEl.textContent = p.full_name || '(kein Name)';

            const emailEl = document.createElement('div');
            emailEl.className = 'employee-info-sub';
            emailEl.textContent = p.email || '';

            // Rolle
            const roleRow = document.createElement('div');
            roleRow.className = 'employee-role';
            const roleLabel = document.createElement('span');
            roleLabel.textContent = 'Rolle: ';
            const roleSelect = document.createElement('select');
            const optUser = document.createElement('option');
            optUser.value = 'user';
            optUser.textContent = 'Mitarbeiter';
            const optAdmin = document.createElement('option');
            optAdmin.value = 'admin';
            optAdmin.textContent = 'Administrator';
            roleSelect.appendChild(optUser);
            roleSelect.appendChild(optAdmin);
            roleSelect.value = p.role || 'user';

            const statusSpan = document.createElement('span');
            statusSpan.style.fontSize = '0.75rem';
            statusSpan.style.marginLeft = '6px';
            statusSpan.style.color = p.is_approved ? '#2e7d32' : '#e65100';
            statusSpan.textContent = p.is_approved ? '(freigegeben)' : '(nicht freigegeben)';

            roleRow.appendChild(roleLabel);
            roleRow.appendChild(roleSelect);
            roleRow.appendChild(statusSpan);

            // Besch√§ftigungsart (nur f√ºr Mitarbeiter, nicht f√ºr Admins)
            let typeSelect = null;
            if (p.role !== 'admin') {
                const typeRow = document.createElement('div');
                typeRow.className = 'employee-role';
                const typeLabel = document.createElement('span');
                typeLabel.textContent = 'Besch√§ftigungsart: ';
                typeSelect = document.createElement('select');
                const optFull = document.createElement('option');
                optFull.value = 'fulltime';
                optFull.textContent = 'Vollzeit';
                const optMini = document.createElement('option');
                optMini.value = 'minijob';
                optMini.textContent = 'Minijob';
                typeSelect.appendChild(optFull);
                typeSelect.appendChild(optMini);
                typeSelect.value = p.employment_type || 'fulltime';

                typeRow.appendChild(typeLabel);
                typeRow.appendChild(typeSelect);
                infoCol.appendChild(typeRow);
            }

            const actions = document.createElement('div');
            actions.className = 'employee-actions';

            const btnOpen = document.createElement('button');
            btnOpen.className = 'btn-small primary';
            btnOpen.textContent = 'Mitarbeiter √∂ffnen';
            btnOpen.addEventListener('click', () => {
                openEmployeeDetail(p);
            });

            const btnSaveRole = document.createElement('button');
            btnSaveRole.className = 'btn-small grey';
            btnSaveRole.textContent = 'Rolle speichern';
            btnSaveRole.addEventListener('click', async () => {
                await updateUserRole(p.id, roleSelect.value, p.email);
            });

            actions.appendChild(btnOpen);
            actions.appendChild(btnSaveRole);

            if (!p.is_approved) {
                const btnApprove = document.createElement('button');
                btnApprove.className = 'btn-small approve';
                btnApprove.textContent = 'Freigeben';
                btnApprove.addEventListener('click', async () => {
                    const employmentType = (roleSelect.value === 'admin')
                        ? null
                        : (typeSelect ? typeSelect.value : null);
                    await approveUser(p, roleSelect.value, employmentType);
                });
                actions.appendChild(btnApprove);
            }

            infoCol.appendChild(nameEl);
            infoCol.appendChild(emailEl);
            infoCol.appendChild(roleRow);
            infoCol.appendChild(actions);

            card.appendChild(avatar);
            card.appendChild(infoCol);

            return card;
        }

        createCategoryBlock('Administratoren', admins);
        createCategoryBlock('Vollzeit-Mitarbeiter', fulltime);
        createCategoryBlock('Minijob-Mitarbeiter', minijob);
        createCategoryBlock('Mitarbeiter (ohne Kategorie)', others);

        adminMessage.textContent = `Es wurden ${data.length} Mitarbeiter geladen.`;
    }

    async function updateUserRole(userId, newRole, email) {
        if (!currentProfile || currentProfile.role !== 'admin') return;

        const sicher = confirm(`Soll die Rolle von "${email}" wirklich auf "${newRole === 'admin' ? 'Administrator' : 'Mitarbeiter'}" ge√§ndert werden?`);
        if (!sicher) return;

        const { error } = await supabase
            .from('profiles')
            .update({ role: newRole })
            .eq('id', userId);

        if (error) {
            adminMessage.textContent = 'Fehler beim Speichern der Rolle: ' + error.message;
            return;
        }

        adminMessage.textContent = 'Rolle erfolgreich ge√§ndert.';
        await loadEmployeeGrid();
    }

    async function approveUser(profileRow, desiredRole, employmentType) {
        if (!currentProfile || currentProfile.role !== 'admin') return;
        const name = profileRow.full_name || profileRow.email;
        const roleText = desiredRole === 'admin' ? 'Administrator' : 'Mitarbeiter';
        const sicher = confirm(`Mitarbeiter "${name}" als "${roleText}" freigeben?`);
        if (!sicher) return;

        const updateData = {
            is_approved: true,
            approved_at: new Date().toISOString(),
            approved_by: currentUser.id
        };
        if (desiredRole) {
            updateData.role = desiredRole;
        }
        // Besch√§ftigungsart nur setzen, wenn nicht Admin
        if (desiredRole !== 'admin' && employmentType) {
            updateData.employment_type = employmentType;
        }

        const { error } = await supabase
            .from('profiles')
            .update(updateData)
            .eq('id', profileRow.id);

        if (error) {
            adminMessage.textContent = 'Fehler beim Freigeben: ' + error.message;
            return;
        }

        const typeText = (desiredRole === 'admin')
            ? ''
            : (employmentType === 'fulltime' ? ' (Vollzeit)' :
               employmentType === 'minijob' ? ' (Minijob)' : '');
        adminMessage.textContent = `Mitarbeiter "${name}" wurde freigeschaltet (${roleText}${typeText}).`;
        await loadEmployeeGrid();
    }

    async function showPortal(user) {
        currentUser = user;
        currentProfile = await loadProfile(user);

        const displayName = currentProfile.full_name || currentProfile.email || user.email;

        if (!currentProfile.is_approved) {
            // Benutzer ist noch nicht freigegeben -> Pending-Ansicht
            authSection.classList.add('hidden');
            portalSection.classList.add('hidden');
            pendingSection.classList.remove('hidden');

            topUserText.textContent = `${displayName} (wartet auf Freigabe)`;
            logoutBtn.classList.remove('hidden');

            pendingMessage.textContent = `Angemeldet als: ${displayName} (${currentProfile.role || 'Mitarbeiter'}). Ihr Zugang ist noch nicht freigegeben.`;
            return;
        }

        // Benutzer ist freigegeben -> volles Portal
        userNameText.textContent = displayName;
        topUserText.textContent = `${displayName} (${currentProfile.role === 'admin' ? 'Administrator' : 'Mitarbeiter'})`;

        sidebarUserRole.textContent = `Rolle: ${currentProfile.role === 'admin' ? 'Administrator' : 'Mitarbeiter'}`;

        if (currentProfile.role === 'admin') {
            roleBadge.classList.remove('hidden');
            roleBadge.textContent = 'Administrator';
            sidebarAdminLabel.classList.remove('hidden');
            sidebarAdminLink.classList.remove('hidden');
            tileAdmin.classList.remove('hidden');
        } else {
            roleBadge.classList.add('hidden');
            sidebarAdminLabel.classList.add('hidden');
            sidebarAdminLink.classList.add('hidden');
            tileAdmin.classList.add('hidden');
            updatePendingBadges(0);
        }

        authSection.classList.add('hidden');
        pendingSection.classList.add('hidden');
        portalSection.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');

        populateSettingsForm(currentProfile, user);

        await loadDocumentsForUser(user);

        if (currentProfile.role === 'admin') {
            await loadEmployeeGrid();
        }

        setActiveSection('section-dashboard');
    }

    function showLogin() {
        currentUser = null;
        currentProfile = null;
        selectedEmployee = null;
        authSection.classList.remove('hidden');
        portalSection.classList.add('hidden');
        pendingSection.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        topUserText.textContent = '';
        clearAuthMessages();
        loginBox.classList.remove('hidden');
        registerBox.classList.add('hidden');
        resetBox.classList.add('hidden');
    }

    // SETTINGS: Profil speichern
    settingsSaveProfile.addEventListener('click', async () => {
        if (!currentUser || !currentProfile) return;
        setSettingsProfileMessage('');

        const firstName = settingsFirstName.value.trim();
        const lastName  = settingsLastName.value.trim();

        if (!firstName || !lastName) {
            setSettingsProfileMessage('Bitte Vor- und Nachnamen ausf√ºllen.', 'error');
            return;
        }

        const fullName = `${firstName} ${lastName}`;

        // Profile-Tabelle aktualisieren
        const { error: profileError } = await supabase
            .from('profiles')
            .update({
                first_name: firstName,
                last_name:  lastName,
                full_name:  fullName
            })
            .eq('id', currentUser.id);

        if (profileError) {
            setSettingsProfileMessage('Fehler beim Speichern des Profils: ' + profileError.message, 'error');
            return;
        }

        // Auth-User-Metadaten aktualisieren (optional, aber sauber)
        const { error: userError } = await supabase.auth.updateUser({
            data: {
                first_name: firstName,
                last_name: lastName,
                full_name: fullName
            }
        });

        if (userError) {
            setSettingsProfileMessage('Profil gespeichert, aber Fehler bei den Auth-Daten: ' + userError.message, 'error');
        } else {
            setSettingsProfileMessage('Profil erfolgreich gespeichert.', 'success');
        }

        // UI aktualisieren
        currentProfile.first_name = firstName;
        currentProfile.last_name  = lastName;
        currentProfile.full_name  = fullName;

        const displayName = fullName || currentProfile.email || currentUser.email;
        userNameText.textContent = displayName;
        topUserText.textContent  = `${displayName} (${currentProfile.role === 'admin' ? 'Administrator' : 'Mitarbeiter'})`;

        // Admin-Ansicht neu laden, damit Namen dort auch aktualisiert sind
        if (currentProfile.role === 'admin') {
            await loadEmployeeGrid();
        }
    });

    // SETTINGS: Passwort √§ndern
    settingsChangePw.addEventListener('click', async () => {
        if (!currentUser || !currentProfile) return;
        setSettingsPasswordMessage('');

        const currentPw = settingsCurrentPw.value.trim();
        const newPw     = settingsNewPw.value.trim();
        const newPw2    = settingsNewPw2.value.trim();

        if (!currentPw || !newPw || !newPw2) {
            setSettingsPasswordMessage('Bitte alle Passwort-Felder ausf√ºllen.', 'error');
            return;
        }
        if (!isStrongPassword(newPw)) {
            setSettingsPasswordMessage('Neues Passwort zu schwach. Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen.', 'error');
            return;
        }
        if (newPw !== newPw2) {
            setSettingsPasswordMessage('Die neuen Passw√∂rter stimmen nicht √ºberein.', 'error');
            return;
        }

        const email = currentProfile.email || currentUser.email;

        // Aktuelles Passwort validieren
        const { error: signInError } = await supabase.auth.signInWithPassword({
            email,
            password: currentPw
        });

        if (signInError) {
            setSettingsPasswordMessage('Aktuelles Passwort ist falsch.', 'error');
            return;
        }

        // Neues Passwort setzen
        const { error: updateError } = await supabase.auth.updateUser({
            password: newPw
        });

        if (updateError) {
            setSettingsPasswordMessage('Fehler beim √Ñndern des Passworts: ' + updateError.message, 'error');
            return;
        }

        setSettingsPasswordMessage('Passwort erfolgreich ge√§ndert.', 'success');
        settingsCurrentPw.value = '';
        settingsNewPw.value     = '';
        settingsNewPw2.value    = '';
    });

    // AUTH EVENTS
    loginBtn.addEventListener('click', async () => {
        clearAuthMessages();
        const email = emailInput.value.trim();
        const pw    = passwordInput.value.trim();

        if (!email || !pw) {
            showAuthError('Bitte E-Mail und Passwort eingeben.');
            return;
        }

        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pw });

        if (error) {
            showAuthError('Login fehlgeschlagen: ' + error.message);
            return;
        }

        showAuthSuccess('Login erfolgreich.');
        if (data.user) await showPortal(data.user);
    });

    registerBtn.addEventListener('click', async () => {
        clearAuthMessages();
        const firstName = regFirstName.value.trim();
        const lastName  = regLastName.value.trim();
        const email     = regEmail.value.trim();
        const pw        = regPassword.value.trim();
        const pw2       = regPassword2.value.trim();

        if (!firstName || !lastName || !email || !pw || !pw2) {
            showAuthError('Bitte alle Felder ausf√ºllen.');
            return;
        }
        if (!isStrongPassword(pw)) {
            showAuthError('Passwort zu schwach. Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen.');
            return;
        }
        if (pw !== pw2) {
            showAuthError('Die Passw√∂rter stimmen nicht √ºberein.');
            return;
        }

        const fullName = `${firstName} ${lastName}`;

        const { error } = await supabase.auth.signUp({
            email,
            password: pw,
            options: {
                data: {
                    first_name: firstName,
                    last_name: lastName,
                    full_name: fullName
                }
            }
        });

        if (error) {
            showAuthError('Registrierung fehlgeschlagen: ' + error.message);
            return;
        }

        showAuthSuccess('Registrierung erfolgreich. Bitte pr√ºfen Sie Ihre E-Mails und best√§tigen Sie Ihre Adresse. Danach muss ein Admin Ihren Zugang freigeben.');

        // Formular leeren und zur√ºck zum Login wechseln
        regFirstName.value = '';
        regLastName.value  = '';
        regEmail.value     = '';
        regPassword.value  = '';
        regPassword2.value = '';

        setTimeout(() => {
            toggleToLogin();
        }, 1500);
    });

    forgotPasswordBtn.addEventListener('click', async () => {
        clearAuthMessages();
        const email = emailInput.value.trim();
        if (!email) {
            showAuthError('Bitte geben Sie zuerst Ihre E-Mail-Adresse ein.');
            return;
        }

        const redirectTo = window.location.origin + window.location.pathname;

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo
        });

        if (error) {
            showAuthError('Fehler beim Senden der Reset-E-Mail: ' + error.message);
            return;
        }

        showAuthSuccess('Falls ein Konto existiert, wurde eine E-Mail zum Zur√ºcksetzen des Passworts gesendet.');
    });

    resetPasswordBtn.addEventListener('click', async () => {
        clearAuthMessages();
        const pw  = resetPasswordInput.value.trim();
        const pw2 = resetPassword2Input.value.trim();

        if (!pw || !pw2) {
            showAuthError('Bitte beide Passwort-Felder ausf√ºllen.');
            return;
        }
        if (!isStrongPassword(pw)) {
            showAuthError('Passwort zu schwach. Mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl oder Sonderzeichen.');
            return;
        }
        if (pw !== pw2) {
            showAuthError('Die Passw√∂rter stimmen nicht √ºberein.');
            return;
        }

        const { error } = await supabase.auth.updateUser({ password: pw });

        if (error) {
            showAuthError('Fehler beim Aktualisieren des Passworts: ' + error.message);
            return;
        }

        showAuthSuccess('Passwort aktualisiert. Sie werden ins Portal eingeloggt.');
        resetPasswordInput.value = '';
        resetPassword2Input.value = '';

        window.location.hash = '';

        const sessionResult = await supabase.auth.getSession();
        const user = sessionResult?.data?.session?.user;
        if (user) {
            await showPortal(user);
        } else {
            showLogin();
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        showLogin();
    });

    pendingLogoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        showLogin();
    });

    // SESSION CHECK & INIT (inkl. Recovery-Check)
    async function checkSession() {
        const { data, error } = await supabase.auth.getSession();
        if (error) {
            console.error('Fehler bei getSession:', error.message);
            showLogin();
            return;
        }

        const hash = window.location.hash || '';
        const isRecovery = hash.includes('type=recovery');

        if (isRecovery && data.session && data.session.user) {
            currentUser = data.session.user;
            authSection.classList.remove('hidden');
            portalSection.classList.add('hidden');
            pendingSection.classList.add('hidden');
            loginBox.classList.add('hidden');
            registerBox.classList.add('hidden');
            resetBox.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            topUserText.textContent = `${currentUser.email} (Passwort zur√ºcksetzen)`;
            clearAuthMessages();
            return;
        }

        if (data.session && data.session.user) {
            await showPortal(data.session.user);
        } else {
            showLogin();
        }
    }

    initNavigation();
    checkSession();
</script>
</body>
</html>
