<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bayrak Mitarbeiter-Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --blue-dark: #004b7a;
            --blue-light: #e7f2fb;
            --orange: #f57c00;
            --grey-bg: #f5f5f5;
            --card-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--grey-bg);
            color: #333;
        }

        /* TOP-LEISTE */
        header {
            background: var(--blue-dark);
            color: #fff;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .brand-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .brand-subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-user {
            font-size: 0.85rem;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-top {
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            background: #c0392b;
            color: #fff;
        }

        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 10px 25px 10px;
        }

        /* AUTH-BEREICH */
        #auth-section {
            max-width: 460px;
            margin: 40px auto;
            background: #fff;
            padding: 20px 18px 22px 18px;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
        }

        #auth-section h2 {
            margin-top: 0;
        }

        #auth-section h3 {
            margin: 10px 0 4px 0;
            font-size: 1rem;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        input[type="email"],
        input[type="password"],
        input[type="text"],
        select { 
            width: 100%;
            padding: 7px 8px;
            margin-top: 3px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            background: #fff;
        }
        
        /* NEU: Passwort-Eingabe Wrapper fÃ¼r Toggle-Icon */
        .password-input-wrapper {
            position: relative;
            margin-top: 3px;
        }
        
        .password-input-wrapper input {
            padding-right: 35px; /* Platz fÃ¼r das Icon */
            margin-top: 0;
        }

        .password-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #777;
            font-size: 1.1rem;
            line-height: 1;
            background: none;
            border: none;
            padding: 0;
            z-index: 10;
        }
        /* ENDE NEU */

        .btn-primary,
        .btn-secondary {
            margin-top: 12px;
            padding: 8px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--blue-dark);
            color: #fff;
        }

        .btn-secondary {
            background: #777;
            color: #fff;
            margin-left: 6px;
        }

        .btn-link {
            background: transparent;
            border: none;
            color: var(--blue-dark);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 8px;
        }

        .info {
            font-size: 0.8rem;
            color: #555;
            margin-top: 8px;
        }

        .error {
            color: #b00020;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .success {
            color: #0a7a1b;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .separator-line {
            margin: 14px 0;
            border-top: 1px solid #eee;
        }

        /* PORTAL-LAYOUT (Sidebar + Inhalt) */
        #portal-section {
            background: transparent;
        }

        .portal-layout {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .portal-layout {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            padding: 14px 12px;
            align-self: flex-start; /* Fixiert Sidebar, wenn Hauptcontent lang ist */
        }

        .sidebar-title {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .sidebar-user {
            font-size: 0.8rem;
            margin-bottom: 12px;
            color: #555;
        }

        .sidebar-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-list li {
            padding: 7px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.1s;
        }

        .sidebar-list li span.icon {
            width: 18px;
            text-align: center;
        }

        .sidebar-list li.active,
        .sidebar-list li:hover {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .sidebar-admin {
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #777;
        }

        .request-badge {
            display: inline-block;
            background: #e53935;
            color: #fff;
            border-radius: 999px;
            font-size: 0.7rem;
            padding: 0 6px;
            margin-left: 4px;
            min-width: 16px;
            text-align: center;
            line-height: 1.4;
        }

        /* Hauptbereich */
        .main-content {
            background: #ffffff;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            padding: 16px 16px 18px 16px;
        }

        .portal-greeting {
            margin-bottom: 14px;
        }

        .portal-greeting h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .portal-greeting p {
            margin: 4px 0 0 0;
            font-size: 0.85rem;
            color: #666;
        }

        .role-badge {
            display: inline-block;
            margin-left: 6px;
            font-size: 0.75rem;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* SECTIONS + DASHBOARD-TILES */
        .portal-section-content {
            margin-top: 10px;
        }

        .tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 6px;
        }

        .tile-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }

        .tile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            background: #fdfdfd;
        }

        .tile-card.active {
            border: 2px solid var(--orange);
            padding: 14px 10px;
        }

        .tile-icon {
            font-size: 1.6rem;
            margin-bottom: 6px;
            color: var(--orange);
        }

        .tile-title {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .tile-sub {
            font-size: 0.8rem;
            color: #777;
        }

        h3.section-title {
            margin: 12px 0 6px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* DOKUMENT-KATEGORIEN */
        .document-category {
            margin-top: 14px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .document-category h4 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .document-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0 0;
        }

        .document-item {
            background: #ffffff;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        .document-item-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .document-item-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .document-item a {
            background: var(--blue-dark);
            color: #fff;
            padding: 6px 9px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .doc-badge-new {
            display: inline-block;
            background: #ff9800;
            color: #fff;
            border-radius: 999px;
            font-size: 0.7rem;
            padding: 0 6px;
            margin-left: 4px;
        }
        
        /* ADMIN OVERVIEW */
        .admin-overview-section {
            background: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .admin-overview-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px dotted #eee;
        }
        
        .admin-overview-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .admin-overview-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .admin-overview-details {
            font-size: 0.8rem;
            color: #555;
            margin-left: 10px;
        }

        .admin-overview-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .btn-link-danger {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font-size: 0.8rem;
            color: #b00020;
        }

        .btn-link-danger:hover {
            text-decoration: underline;
        }

        /* ADMIN: MITARBEITER-KACHELN */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .employee-card {
            border-radius: 6px;
            padding: 8px 8px 10px 8px;
            box-shadow: var(--card-shadow);
            background: #fafafa;
            display: grid;
            grid-template-columns: 40px minmax(0, 1fr);
            gap: 6px;
            font-size: 0.8rem;
        }

        .employee-card.pending {
            border: 2px solid #ff9800;
            background: #fff7e6;
        }

        .employee-card.admin {
            border: 2px solid var(--blue-dark);
            background: #e7f2fb;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #555;
            border: 2px solid #4caf50;
        }

        .employee-info-main {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .employee-info-sub {
            font-size: 0.8rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .employee-role-selector {
            margin-top: 4px;
            display: flex;
            gap: 4px;
            align-items: center;
            font-size: 0.75rem;
            flex-wrap: wrap;
        }

        .employee-role-selector label {
             margin: 0;
             margin-right: 4px;
        }

        .employee-role-selector select {
            font-size: 0.75rem;
            padding: 3px 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: auto;
            flex: 1;
            min-width: 80px;
        }

        .employee-actions {
            grid-column: 1 / 3;
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 4px 6px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            line-height: 1.5;
        }

        .btn-small.primary {
            background: var(--blue-dark);
            color: #fff;
        }

        .btn-small.grey {
            background: #777;
            color: #fff;
        }

        .btn-small.approve {
            background: #2e7d32;
            color: #fff;
        }

        .admin-message {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .employee-category-wrapper {
            margin-bottom: 16px;
        }

        .employee-category-heading {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 18px 0 6px 0;
            color: #444;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .employee-category-heading:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* SETTINGS */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .settings-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 12px 12px 14px 12px;
            box-shadow: var(--card-shadow);
        }

        .settings-card h4 {
            margin: 0 0 6px 0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .settings-card p {
            margin: 4px 0 8px 0;
            font-size: 0.8rem;
            color: #666;
        }

        .settings-inline {
            display: flex;
            gap: 8px;
        }

        .settings-inline > div {
            flex: 1;
        }

        .settings-message {
            margin-top: 6px;
            font-size: 0.8rem;
        }

        /* PENDING-SECTION (nicht freigegeben) */
        #pending-section {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            padding: 20px 18px 22px 18px;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
        }

        #pending-section h2 {
            margin-top: 0;
        }

        @media (max-width: 600px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .top-right {
                align-self: stretch;
                justify-content: space-between;
            }
            .top-user {
                max-width: none;
            }

            .settings-inline {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="brand-logo">B</div>
        <div>
            <div class="brand-title">Bayrak Mitarbeiter-Portal</div>
            <div class="brand-subtitle">Interne Web-App Â· Testversion</div>
        </div>
    </div>
    <div class="top-right">
        <div class="top-user" id="top-user-text"></div>
        <span id="inactivity-timer" class="hidden" style="color: #f57c00; font-weight: bold; font-size: 0.8rem; margin-right: 6px;">10:00</span>
        <button id="logout-btn" class="btn-top hidden">Abmelden</button>
    </div>
</header>

<main>
    <section id="auth-section">
        <h2>Anmeldung</h2>
        <div id="auth-error" class="error hidden"></div>
        <div id="auth-success" class="success hidden"></div>

        <div id="login-box">
            <h3>Einloggen</h3>
            <label for="email">E-Mail</label>
            <input type="email" id="email" placeholder="deine@email.de" autocomplete="username">

            <label for="password">Passwort</label>
            <div class="password-input-wrapper">
                <input type="password" id="password" placeholder="Passwort" autocomplete="current-password">
                <button class="password-toggle" data-target="password" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
            </div>

            <button id="login-btn" class="btn-primary">Einloggen</button>

            <button id="forgot-password-btn" class="btn-link" type="button">Passwort vergessen?</button>

            <div class="separator-line"></div>

            <p class="info">Sie haben noch kein Konto?</p>
            <button id="show-register-btn" class="btn-secondary">Neu anmelden</button>
        </div>


        <div id="forgot-box" class="hidden">
            <h3>Passwort zurÃ¼cksetzen</h3>
            <p class="info">Bitte geben Sie Ihre E-Mail-Adresse ein. Wir senden Ihnen einen Link zum ZurÃ¼cksetzen des Passworts.</p>
            <label for="forgot-email">E-Mail</label>
            <input type="email" id="forgot-email" placeholder="deine@email.de" autocomplete="username">
            <div class="button-row">
                <button id="forgot-send-btn" class="btn-primary" type="button">Senden</button>
                <button id="forgot-back-btn" class="btn-secondary" type="button">ZurÃ¼ck zum Login</button>
            </div>
        </div>

        <div id="register-box" class="hidden">
            <h3>Neu anmelden</h3>

            <label for="reg-first-name">Vorname</label>
            <input type="text" id="reg-first-name" placeholder="Vorname" autocomplete="given-name">

            <label for="reg-last-name">Nachname</label>
            <input type="text" id="reg-last-name" placeholder="Nachname" autocomplete="family-name">

            <label for="reg-email">E-Mail</label>
            <input type="email" id="reg-email" placeholder="E-Mail" autocomplete="email">

            <label for="reg-password">Passwort</label>
            <div class="password-input-wrapper">
                <input type="password" id="reg-password" placeholder="Mindestens 8 Zeichen, 1 GroÃŸbuchstabe, 1 Zahl oder Sonderzeichen" autocomplete="new-password">
                <button class="password-toggle" data-target="reg-password" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
            </div>

            <label for="reg-password2">Passwort wiederholen</label>
            <div class="password-input-wrapper">
                <input type="password" id="reg-password2" placeholder="Passwort bestÃ¤tigen" autocomplete="new-password">
                <button class="password-toggle" data-target="reg-password2" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
            </div>

            <button id="register-btn" class="btn-primary">Registrierung abschlieÃŸen</button>
            <button id="back-to-login-btn" class="btn-secondary">ZurÃ¼ck zum Login</button>

            <p class="info">
                Nach der Registrierung erhalten Sie eine E-Mail zur BestÃ¤tigung Ihrer Adresse.<br>
                AnschlieÃŸend muss ein Administrator Ihren Zugang freigeben, bevor Sie das Portal nutzen kÃ¶nnen.
            </p>
        </div>

        <div id="reset-box" class="hidden">
            <h3>Neues Passwort setzen</h3>
            <p class="info">
                Sie haben einen Link â€Passwort zurÃ¼cksetzenâ€œ verwendet. Bitte wÃ¤hlen Sie jetzt ein neues Passwort.
            </p>

            <label for="reset-password">Neues Passwort</label>
            <div class="password-input-wrapper">
                <input type="password" id="reset-password" placeholder="Mindestens 8 Zeichen, 1 GroÃŸbuchstabe, 1 Zahl oder Sonderzeichen" autocomplete="new-password">
                <button class="password-toggle" data-target="reset-password" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
            </div>

            <label for="reset-password2">Passwort wiederholen</label>
            <div class="password-input-wrapper">
                <input type="password" id="reset-password2" placeholder="Neues Passwort bestÃ¤tigen" autocomplete="new-password">
                <button class="password-toggle" data-target="reset-password2" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
            </div>

            <button id="reset-password-btn" class="btn-primary">Passwort speichern</button>
        </div>
    </section>

    <section id="pending-section" class="hidden">
        <h2>Registrierung ausstehend</h2>
        <p id="pending-message" class="info"></p>
        <p class="info">
            Ihre Registrierung wurde erfolgreich gespeichert und Ihre E-Mail-Adresse ist bestÃ¤tigt.<br>
            Ein Administrator wird Ihren Zugang prÃ¼fen und freigeben. Sobald dies erfolgt ist, kÃ¶nnen Sie sich normal einloggen.
        </p>
        <button id="pending-logout-btn" class="btn-primary">Abmelden</button>
    </section>

    <section id="portal-section" class="hidden">
        <div class="portal-layout">
            <aside class="sidebar">
                <div class="sidebar-title">Mitarbeiterportal</div>
                <div class="sidebar-user" id="sidebar-user-role"></div>

                <ul class="sidebar-list" id="sidebar-nav">
                    <li data-target="section-dashboard" class="active">
                        <span class="icon">ğŸ </span> <span>Startseite</span>
                    </li>
                    <li data-target="section-training-records">
                        <span class="icon">âœ…</span> <span>Dokumente & Uploads</span>
                    </li>
                    <li data-target="section-timesheet">
                        <span class="icon">ğŸ•’</span> <span>Stundenzettel</span>
                    </li>
                    <li data-target="section-sicknotes">
                        <span class="icon">ğŸ¥</span> <span>Krankmeldungen</span>
                    </li>
                    <li data-target="section-settings">
                        <span class="icon">âš™ï¸</span> <span>Einstellungen</span>
                    </li>
                    <li data-target="section-admin" id="sidebar-admin-link" class="hidden">
                        <span class="icon">ğŸ› </span> <span>Admin Â· Mitarbeiter</span>
                        <span id="sidebar-admin-badge" class="request-badge hidden"></span>
                    </li>
                    <li data-target="section-admin-uploads" id="sidebar-admin-uploads-link" class="hidden">
                        <span class="icon">ğŸ“¥</span> <span>Admin Â· Uploads</span>
                    </li>
                </ul>

                <div id="sidebar-admin-label" class="sidebar-admin hidden">
                    Sie sind <strong>Administrator</strong> und kÃ¶nnen Mitarbeiter &amp; Rollen verwalten.
                </div>
            </aside>

            <div class="main-content">
                <div class="portal-greeting">
                    <h2>
                        Guten Tag,
                        <span id="user-name-text">Mitarbeiter</span>
                        <span id="role-badge" class="role-badge hidden"></span>
                    </h2>
                    <p>Willkommen im Bayrak Mitarbeiter-Portal. WÃ¤hlen Sie eine Kachel oder einen MenÃ¼punkt.</p>
                </div>

                <div id="section-dashboard" class="portal-section-content">
                    <div class="tile-grid">
                        <div class="tile-card active" data-target="section-training-records">
                            <div class="tile-icon">âœ…</div>
                            <div class="tile-title">Dokumente & Uploads</div>
                            <div class="tile-sub">Nachweise, Stundenzettel, Krankmeldungen</div>
                        </div>
                        <div class="tile-card" data-target="section-timesheet">
                            <div class="tile-icon">ğŸ•’</div>
                            <div class="tile-title">Stundenzettel</div>
                            <div class="tile-sub">Arbeitszeiten erfassen (Platzhalter)</div>
                        </div>
                        <div class="tile-card" data-target="section-sicknotes">
                            <div class="tile-icon">ğŸ¥</div>
                            <div class="tile-title">Krankmeldungen</div>
                            <div class="tile-sub">AU-Bescheinigung hochladen</div>
                        </div>
                        <div class="tile-card" data-target="section-settings">
                            <div class="tile-icon">âš™ï¸</div>
                            <div class="tile-title">Einstellungen</div>
                            <div class="tile-sub">Profil & Passwort</div>
                        </div>
                        <div id="tile-admin" class="tile-card hidden" data-target="section-admin">
                            <div class="tile-icon">ğŸ‘¥</div>
                            <div class="tile-title">
                                Mitarbeiter (Admin)
                                <span id="tile-admin-badge" class="request-badge hidden"></span>
                            </div>
                            <div class="tile-sub">Ãœbersicht & Rollen</div>
                        </div>
                        <div id="tile-admin-uploads" class="tile-card hidden" data-target="section-admin-uploads">
                            <div class="tile-icon">ğŸ“¥</div>
                            <div class="tile-title">Admin Uploads</div>
                            <div class="tile-sub">Dateien fÃ¼r Mitarbeiter hochladen</div>
                        </div>
                    </div>
                </div>

                <div id="section-training-records" class="portal-section-content hidden">
                    <h3 class="section-title">Dokumente, Nachweise & Uploads</h3>
                    <p class="info">
                        In diesem Bereich sehen Sie:
                        <br>â€¢ Unterweisungsnachweise (vom Admin bereitgestellt)
                        <br>â€¢ Ihre hochgeladenen Stundenzettel-Nachweise
                        <br>â€¢ Ihre hochgeladenen Krankmeldungen-Nachweise
                    </p>

                    <div class="document-category">
                        <h4>Unterweisungen (vom Admin bereitgestellt)</h4>
                        <div id="docs-unterweisungen-message" class="info">Es sind keine Unterweisungen fÃ¼r Sie hinterlegt.</div>
                        <ul id="docs-unterweisungen-list" class="document-list"></ul>
                    </div>

                    <div class="document-category">
                        <h4>Stundenzettel-Nachweise (Ihr Upload)</h4>
                        <p class="info">
                            Laden Sie hier Ihre Stundenzettel / Rapporte als PDF oder Foto hoch.
                        </p>
                        <button id="upload-timesheet-btn" class="btn-primary">Stundenzettel hochladen</button>
                        <input type="file" id="upload-timesheet-input" accept="image/*,application/pdf" capture="environment" class="hidden">
                        <div id="docs-timesheets-message" class="info">Es wurden noch keine Stundenzettel von Ihnen hochgeladen.</div>
                        <ul id="docs-timesheets-list" class="document-list"></ul>
                    </div>
                </div>

                <div id="section-sicknotes" class="portal-section-content hidden">
                    <h3 class="section-title">Krankmeldungen (Ihr Upload)</h3>
                    <div class="document-category" style="padding-top: 0; border-top: none;">
                        <p class="info">
                            Hier kÃ¶nnen Sie Ihre Krankmeldungen (AU-Bescheinigungen) als Foto oder PDF hochladen. Die Admins sehen diese in ihrer Ãœbersicht.
                        </p>
                        <button id="upload-sicknote-btn" class="btn-primary">Krankmeldung hochladen</button>
                        <input type="file" id="upload-sicknote-input" accept="image/*,application/pdf" capture="environment" class="hidden">
                        <div id="docs-sicknotes-message" class="info"></div>
                        <h4 style="margin-top:18px;">Ihre hochgeladenen Krankmeldungen</h4>
                        <div id="sicknotes-user-message" class="info">Es wurden noch keine Krankmeldungen von Ihnen hochgeladen.</div>
                        <ul id="docs-sicknotes-list" class="document-list"></ul>
                    </div>
                </div>

                <div id="section-timesheet" class="portal-section-content hidden">
                    <h3 class="section-title">Stundenzettel</h3>
                    <p class="info">
                        Hier wird spÃ¤ter die Stundenzettel-Funktion integriert (mit Speicherung in Supabase).
                        <br><strong>Aktuell ist dies nur ein Platzhalter.</strong>
                    </p>
                </div>

                <div id="section-settings" class="portal-section-content hidden">
                    <h3 class="section-title">Einstellungen</h3>
                    <p class="info">
                        Hier kÃ¶nnen Sie Ihre Profildaten bearbeiten und Ihr Passwort Ã¤ndern.
                    </p>

                    <div class="settings-grid">
                        <div class="settings-card">
                            <h4>Profildaten</h4>
                            <p>Aktualisieren Sie hier Ihren Namen.</p>

                            <div class="settings-inline">
                                <div>
                                    <label for="settings-first-name">Vorname</label>
                                    <input type="text" id="settings-first-name" placeholder="Vorname">
                                </div>
                                <div>
                                    <label for="settings-last-name">Nachname</label>
                                    <input type="text" id="settings-last-name" placeholder="Nachname">
                                </div>
                            </div>

                            <label for="settings-email">E-Mail</label>
                            <input type="email" id="settings-email" disabled>
                            
                            <label for="settings-employment-type" id="settings-employment-label">BeschÃ¤ftigungsart</label>
                            <select id="settings-employment-type">
                                <option value="fulltime">Vollzeit</option>
                                <option value="minijob">Minijob</option>
                            </select>

                            <button id="settings-save-profile" class="btn-primary">Profil speichern</button>
                            <div id="settings-profile-msg" class="settings-message"></div>
                        </div>

                        <div class="settings-card">
                            <h4>Passwort Ã¤ndern</h4>
                            <p>Das neue Passwort muss mindestens 8 Zeichen, einen GroÃŸbuchstaben und eine Zahl oder ein Sonderzeichen enthalten.</p>

                            <label for="settings-current-password">Aktuelles Passwort</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="settings-current-password" placeholder="Aktuelles Passwort" autocomplete="current-password">
                                <button class="password-toggle" data-target="settings-current-password" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
                            </div>

                            <label for="settings-new-password">Neues Passwort</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="settings-new-password" placeholder="Neues Passwort" autocomplete="new-password">
                                <button class="password-toggle" data-target="settings-new-password" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
                            </div>

                            <label for="settings-new-password2">Neues Passwort wiederholen</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="settings-new-password2" placeholder="Neues Passwort bestÃ¤tigen" autocomplete="new-password">
                                <button class="password-toggle" data-target="settings-new-password2" type="button" aria-label="Passwort anzeigen">ğŸ‘ï¸</button>
                            </div>

                            <button id="settings-change-password" class="btn-primary">Passwort Ã¤ndern</button>
                            <div id="settings-password-msg" class="settings-message"></div>
                        </div>
                    </div>
                </div>

                <div id="section-admin" class="portal-section-content hidden">
                    <h3 class="section-title">
                        Admin Â· MitarbeiterÃ¼bersicht
                        <span id="admin-requests-counter" class="request-badge hidden"></span>
                    </h3>
                    <p class="info">
                        Verwalten Sie hier alle registrierten Mitarbeiter, geben Sie neue Benutzer frei und Ã¤ndern Sie Rollen (Admin/User).
                    </p>

                    <div class="employee-category-wrapper">
                        <div class="employee-category-heading">
                            Neue Registrierungen (Wartet auf Freigabe)
                        </div>
                        <div id="pending-employees-content">
                            <p class="info" id="no-pending-users">Keine Benutzer warten auf Freigabe.</p>
                        </div>
                    </div>

                    <div class="employee-category-wrapper">
                        <div class="employee-category-heading">
                            Alle freigegebenen Mitarbeiter
                        </div>
                        <div id="approved-employees-content">
                            <p class="info">Wird geladen...</p>
                        </div>
                    </div>
                </div>
                
                <div id="section-admin-uploads" class="portal-section-content hidden">
                    <h3 class="section-title">Admin Â· Uploads und Dokumentenverwaltung</h3>
                    
                    <div class="settings-grid">
                        <div class="settings-card">
                            <h4>Unterweisungsnachweise hochladen</h4>
                            <p>Stellen Sie hier ein Dokument fÃ¼r einen oder alle Mitarbeiter bereit.</p>

                            <div class="settings-inline">
                                <div>
                                    <label for="admin-unterweisungen-scope">Geltungsbereich</label>
                                    <select id="admin-unterweisungen-scope">
                                        <option value="all">Alle freigegebenen Mitarbeiter</option>
                                        <option value="single">Einzelner Mitarbeiter</option>
                                    </select>
                                </div>
                                <div id="admin-unterweisungen-user-select-wrapper" class="hidden">
                                    <label for="admin-unterweisungen-user-select">Mitarbeiter auswÃ¤hlen</label>
                                    <select id="admin-unterweisungen-user-select"></select>
                                </div>
                            </div>
                            <label for="admin-unterweisungen-input" style="margin-top: 10px;">Datei auswÃ¤hlen (PDF/Bild)</label>
                            <input type="file" id="admin-unterweisungen-input" accept="image/*,application/pdf">

                            <button id="admin-unterweisungen-upload-btn" class="btn-primary" style="margin-top: 10px;">Dokument hochladen</button>
                            <div id="admin-unterweisungen-message" class="settings-message"></div>
                        </div>

                        <div class="settings-card">
                            <h4>Ãœbersicht Stundenzettel-Uploads (Mitarbeiter)</h4>
                            <p class="info" id="admin-timesheets-new-count">Wird geladen...</p>
                            <div class="admin-overview-section" id="admin-timesheets-overview">
                                Wird geladen...
                            </div>
                        </div>

                        <div class="settings-card">
                            <h4>Ãœbersicht Krankmeldungen-Uploads (Mitarbeiter)</h4>
                            <p class="info" id="admin-sicknotes-new-count">Wird geladen...</p>
                            <div class="admin-overview-section" id="admin-sicknotes-overview">
                                Wird geladen...
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-employee-detail" class="portal-section-content hidden">
                    <h3 class="section-title">Mitarbeiter-Details: <span id="employee-detail-info-title"></span></h3>
                    <div id="employee-detail-meta" class="info" style="margin-bottom:12px;"></div>
                    <button id="employee-detail-back-btn" class="btn-secondary" style="margin-bottom: 15px;">ZurÃ¼ck zur Ãœbersicht</button>

                    <h4>Hochgeladene Dokumente</h4>
                    <ul id="employee-detail-docs" class="document-list"></ul>
                </div>
            </div>
        </div>
    </section>
</main>

<script type="module">
    // --- KONFIGURATION: BITTE HIER IHRE URL & KEY EINFÃœGEN ---
    const SUPABASE_URL = 'https://tieypqqmdpzpxzxottik.supabase.co'; // <--- PRÃœFEN SIE DIESE URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpZXlwcXFtZHB6cHh6eG90dGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1Nzk0MjMsImV4cCI6MjA4MDE1NTQyM30.zvG9iGzuXOyfYU3mAvqQEXUrFDnmyrupwG0uYG6qf_c'; // <--- PRÃœFEN SIE DIESEN KEY
    const STORAGE_BUCKET = 'documents';

    // Supabase-Client initialisieren
    // WICHTIG: Verwenden von 'let' und defensive Initialisierung, um Fatal Errors zu vermeiden.
    let supabaseClient = null; 

    if (window.supabase && window.supabase.createClient) {
        // Erfolgreiche Initialisierung
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        // Fehler beim Laden der CDN-Bibliothek (hÃ¤ufigste Ursache fÃ¼r nicht funktionierende Buttons)
        console.error("FATAL ERROR: Supabase-Bibliothek (CDN) wurde nicht geladen. Das Skript kann nicht ausgefÃ¼hrt werden.");
        // Eine Fehler-Variable, die spÃ¤ter von init() erkannt wird, wird automatisch gesetzt, da supabaseClient null ist.
    }
    
    // Globale Variablen
    let currentUser = null;
    let currentProfile = null;
    let allProfilesCache = []; // FÃ¼r Admin-Auswahl

    // DOM-Referenzen
    const authSection = document.getElementById('auth-section');
    const portalSection = document.getElementById('portal-section');
    const pendingSection = document.getElementById('pending-section');
    const loginBox = document.getElementById('login-box');
    const registerBox = document.getElementById('register-box');
    const resetBox = document.getElementById('reset-box');
    const forgotBox = document.getElementById('forgot-box');
    const authError = document.getElementById('auth-error');
    const authSuccess = document.getElementById('auth-success');

    // Inputs Auth
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const forgotPasswordBtn = document.getElementById('forgot-password-btn');
    const showRegisterBtn = document.getElementById('show-register-btn');
    const backToLoginBtn = document.getElementById('back-to-login-btn');
    const forgotEmailInput = document.getElementById('forgot-email');
    const forgotSendBtn = document.getElementById('forgot-send-btn');
    const forgotBackBtn = document.getElementById('forgot-back-btn');

    // Register Inputs
    const regFirstName = document.getElementById('reg-first-name');
    const regLastName = document.getElementById('reg-last-name');
    const regEmail = document.getElementById('reg-email');
    const regPassword = document.getElementById('reg-password');
    const regPassword2 = document.getElementById('reg-password2');
    const registerBtn = document.getElementById('register-btn');

    // Reset Inputs
    const resetPassword = document.getElementById('reset-password');
    const resetPassword2 = document.getElementById('reset-password2');
    const resetPasswordBtn = document.getElementById('reset-password-btn');

    // Portal Elements
    const logoutBtn = document.getElementById('logout-btn');
    const pendingLogoutBtn = document.getElementById('pending-logout-btn');
    const topUserText = document.getElementById('top-user-text');
    const userNameText = document.getElementById('user-name-text');
    const roleBadge = document.getElementById('role-badge');
    const sidebarUserRole = document.getElementById('sidebar-user-role');
    const sidebarAdminLink = document.getElementById('sidebar-admin-link');
    const sidebarAdminUploadsLink = document.getElementById('sidebar-admin-uploads-link');
    const sidebarAdminBadge = document.getElementById('sidebar-admin-badge');
    const sidebarAdminLabel = document.getElementById('sidebar-admin-label');
    const tileAdmin = document.getElementById('tile-admin');
    const tileAdminUploads = document.getElementById('tile-admin-uploads');
    const tileAdminBadge = document.getElementById('tile-admin-badge');
    const sidebarNav = document.getElementById('sidebar-nav');
    const portalSections = document.querySelectorAll('.portal-section-content');

    // Admin Elements
    const pendingEmployeesContent = document.getElementById('pending-employees-content');
    const approvedEmployeesContent = document.getElementById('approved-employees-content');
    const noPendingUsers = document.getElementById('no-pending-users');
    const adminRequestsCounter = document.getElementById('admin-requests-counter');
    const adminTimesheetsOverview = document.getElementById('admin-timesheets-overview');
    const adminTimesheetsNewCount = document.getElementById('admin-timesheets-new-count');
    const adminSicknotesOverview = document.getElementById('admin-sicknotes-overview');
    const adminSicknotesNewCount = document.getElementById('admin-sicknotes-new-count');
    const adminUnterwScope = document.getElementById('admin-unterweisungen-scope');
    const adminUnterwUserSelectWrapper = document.getElementById('admin-unterweisungen-user-select-wrapper');
    const adminUnterwUserSelect = document.getElementById('admin-unterweisungen-user-select');
    const adminUnterwInput = document.getElementById('admin-unterweisungen-input');
    const adminUnterwUploadBtn = document.getElementById('admin-unterweisungen-upload-btn');
    const adminUnterwMessage = document.getElementById('admin-unterweisungen-message');

    // Employee Detail
    const employeeDetailInfoTitle = document.getElementById('employee-detail-info-title');
    const employeeDetailMeta = document.getElementById('employee-detail-meta');
    const employeeDetailDocs = document.getElementById('employee-detail-docs');
    const employeeDetailBackBtn = document.getElementById('employee-detail-back-btn');

    // Documents
    const docsUnterwList = document.getElementById('docs-unterweisungen-list');
    const docsUnterwMessage = document.getElementById('docs-unterweisungen-message');
    const uploadTimesheetBtn = document.getElementById('upload-timesheet-btn');
    const uploadTimesheetInput = document.getElementById('upload-timesheet-input');
    const docsTimesheetsList = document.getElementById('docs-timesheets-list');
    const docsTimesheetsMessage = document.getElementById('docs-timesheets-message');
    const uploadSicknoteBtn = document.getElementById('upload-sicknote-btn');
    const uploadSicknoteInput = document.getElementById('upload-sicknote-input');
    const docsSicknotesList = document.getElementById('docs-sicknotes-list');
    const docsSicknotesMessage = document.getElementById('docs-sicknotes-message');
    const sicknotesUserMessage = document.getElementById('sicknotes-user-message');

    // Settings
    const settingsFirstName = document.getElementById('settings-first-name');
    const settingsLastName = document.getElementById('settings-last-name');
    const settingsEmail = document.getElementById('settings-email');
    const settingsEmploymentType = document.getElementById('settings-employment-type');
    const settingsSaveProfile = document.getElementById('settings-save-profile');
    const settingsProfileMsg = document.getElementById('settings-profile-msg');
    const settingsCurrentPw = document.getElementById('settings-current-password');
    const settingsNewPw = document.getElementById('settings-new-password');
    const settingsNewPw2 = document.getElementById('settings-new-password2');
    const settingsChangePw = document.getElementById('settings-change-password');
    const settingsPasswordMsg = document.getElementById('settings-password-msg');

    // Timer
    const inactivityTimerEl = document.getElementById('inactivity-timer');
    const INACTIVITY_LIMIT_MS = 10 * 60 * 1000; // 10 Min
    let inactivityTimeout;
    let timerInterval;
    let timeRemaining = INACTIVITY_LIMIT_MS / 1000;

    // --- HELPER FUNCTIONS ---

    function isStrongPassword(pw) {
        if (!pw || pw.length < 8) return false;
        // Min 8 chars, 1 Uppercase, 1 Digit OR Special Char
        const hasUpper = /[A-ZÃ„Ã–Ãœ]/.test(pw);
        const hasDigitOrSpecial = /[0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/.test(pw);
        return hasUpper && hasDigitOrSpecial;
    }

    function makeSafeFileName(name) {
        return name.replace(/[^a-zA-Z0-9._-]/g, '_');
    }

    function showAuthError(msg) {
        authError.textContent = msg;
        authError.classList.remove('hidden');
        authSuccess.classList.add('hidden');
    }

    function showAuthSuccess(msg) {
        authSuccess.textContent = msg;
        authSuccess.classList.remove('hidden');
        authError.classList.add('hidden');
    }

    function clearAuthMessages() {
        authError.textContent = '';
        authError.classList.add('hidden');
        authSuccess.textContent = '';
        authSuccess.classList.add('hidden');
    }
    
    // NEU: Passwort-Umschalter Logik
    function handlePasswordToggle(e) {
        const toggle = e.currentTarget;
        const targetId = toggle.getAttribute('data-target');
        const targetInput = document.getElementById(targetId);

        if (targetInput.type === 'password') {
            targetInput.type = 'text';
            toggle.textContent = 'ğŸ”’'; // Icon fÃ¼r Ausblenden
            toggle.setAttribute('aria-label', 'Passwort ausblenden');
        } else {
            targetInput.type = 'password';
            toggle.textContent = 'ğŸ‘ï¸'; // Icon fÃ¼r Anzeigen
            toggle.setAttribute('aria-label', 'Passwort anzeigen');
        }
    }
    // ENDE NEU

    // --- INACTIVITY TIMER ---

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        inactivityTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (timeRemaining <= 60) {
            inactivityTimerEl.style.color = '#e53935'; // rot
        } else {
            inactivityTimerEl.style.color = '#f57c00'; // orange
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        timeRemaining = INACTIVITY_LIMIT_MS / 1000;
        updateTimerDisplay();
        inactivityTimerEl.classList.remove('hidden');

        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                inactivityTimerEl.classList.add('hidden');
                supabaseClient.auth.signOut().then(() => {
                    alert('Sie wurden wegen InaktivitÃ¤t abgemeldet.');
                    showLogin();
                });
            }
        }, 1000);
    }

    function resetInactivityTimer() {
        if (currentUser) {
            clearTimeout(inactivityTimeout);
            clearInterval(timerInterval);
            inactivityTimeout = setTimeout(startTimer, INACTIVITY_LIMIT_MS - (10 * 60 * 1000) + (1 * 60 * 1000)); // Start timer 1 min before limit
            startTimer();
        }
    }

    function setupActivityListeners() {
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
    }

    // --- NAVIGATION ---

    function setActiveSection(targetId) {
        portalSections.forEach(el => {
            const id = el.getAttribute('id');
            if(id === targetId) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });

        // Sidebar Active State
        const items = sidebarNav.querySelectorAll('li');
        items.forEach(li => {
            const t = li.getAttribute('data-target');
            if(t === targetId) li.classList.add('active');
            else li.classList.remove('active');
        });

        // Tile Active State
        document.querySelectorAll('.tile-card').forEach(tile => {
            const t = tile.getAttribute('data-target');
            if(t === targetId) tile.classList.add('active');
            else tile.classList.remove('active');
        });

        // Load content on demand
        if (targetId === 'section-training-records' || targetId === 'section-sicknotes') {
            loadDocumentsForUser(currentUser);
        }
        if (targetId === 'section-admin' && currentProfile?.role === 'admin') {
            loadEmployeeGrid();
        }
        if (targetId === 'section-admin-uploads' && currentProfile?.role === 'admin') {
            loadAdminDocumentOverviews();
        }
    }

    function initNavigation() {
        sidebarNav.querySelectorAll('li').forEach(li => {
            li.addEventListener('click', () => {
                const target = li.getAttribute('data-target');
                if(target) setActiveSection(target);
            });
        });

        document.querySelectorAll('.tile-card').forEach(tile => {
            tile.addEventListener('click', () => {
                const target = tile.getAttribute('data-target');
                if(target) setActiveSection(target);
            });
        });

        employeeDetailBackBtn.addEventListener('click', () => {
            setActiveSection('section-admin');
        });
    }

    // --- AUTH FLOW UI ---

    function disableAuthButtons() {
        loginBtn.disabled = true;
        forgotPasswordBtn.disabled = true;
        showRegisterBtn.disabled = true;
        registerBtn.disabled = true;
        backToLoginBtn.disabled = true;
        resetPasswordBtn.disabled = true;
    }

    function showLogin() {
        currentUser = null;
        currentProfile = null;
        clearTimeout(inactivityTimeout);
        clearInterval(timerInterval);
        inactivityTimerEl.classList.add('hidden');

        authSection.classList.remove('hidden');
        portalSection.classList.add('hidden');
        pendingSection.classList.add('hidden');

        loginBox.classList.remove('hidden');
        registerBox.classList.add('hidden');
        resetBox.classList.add('hidden');
        
        logoutBtn.classList.add('hidden');
        topUserText.textContent = '';
        clearAuthMessages();

        if (supabaseClient) {
            loginBtn.disabled = false;
            forgotPasswordBtn.disabled = false;
            showRegisterBtn.disabled = false;
        }
    }

    function showPending(user) {
        currentUser = user;

        authSection.classList.add('hidden');
        portalSection.classList.add('hidden');
        pendingSection.classList.remove('hidden');

        logoutBtn.classList.remove('hidden');
        topUserText.textContent = `${user.email} (wartet auf Freigabe)`;
        pendingMessage.textContent = `Angemeldet als: ${user.email}. Bitte warten Sie auf die Freischaltung.`;
        resetInactivityTimer();
    }

        
    async function showPortal(user) {
        currentUser = user;

        // Profil laden
        let { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        // Wenn kein Profil: Fallback â†’ versuchen anzulegen, aber Admin NIE aussperren
        if (error || !profile) {
            console.warn('Profil nicht gefunden, versuche Fallback-Profil anzulegen', error);

            const meta = user.user_metadata || {};
            const firstName = meta.first_name || '';
            const lastName = meta.last_name || '';
            const fullName =
                meta.full_name ||
                `${firstName} ${lastName}`.trim() ||
                user.email;

            // Best Effort: Profil in Tabelle anlegen â€“ Fehler werden geloggt, aber Admin kommt trotzdem rein
            // Sonderfall: erster Benutzer im System wird automatisch Admin, alle weiteren als normale Mitarbeiter angelegt
            let insertData = null;
            let shouldBecomeAdmin = false;
            try {
                const { data: existingProfiles, error: countError } = await supabaseClient
                    .from('profiles')
                    .select('id, role');

                if (!countError && existingProfiles && existingProfiles.length === 0) {
                    shouldBecomeAdmin = true;
                }

                const insertResult = await supabaseClient
                    .from('profiles')
                    .insert({
                        id: user.id,
                        email: user.email,
                        first_name: firstName,
                        last_name: lastName,
                        full_name: fullName,
                        role: shouldBecomeAdmin ? 'admin' : 'user',
                        is_approved: shouldBecomeAdmin ? true : false,
                        employment_type: shouldBecomeAdmin ? 'fulltime' : null
                    })
                    .select('*')
                    .single();

                insertData = insertResult.data;
            } catch (e) {
                console.error('Profil konnte nicht angelegt werden (RLS oder andere Ursache)', e);
            }

            profile = insertData || {
                id: user.id,
                email: user.email,
                first_name: firstName,
                last_name: lastName,
                full_name: fullName,
                role: 'admin',
                is_approved: true,
                employment_type: 'fulltime'
            };
        }

        currentProfile = profile;

        const isAdmin = profile.role === 'admin';
        const isApproved = profile.is_approved || isAdmin;

        // Nur normale User ohne Freigabe sehen "Registrierung ausstehend"
        if (!isApproved && !isAdmin) {
            showPending(user);
            return;
        }

        // === Portal anzeigen ===
        authSection.classList.add('hidden');
        pendingSection.classList.add('hidden');
        portalSection.classList.remove('hidden');
        
        // UI aktualisieren
        const name = profile.full_name || user.email;
        const roleText = isAdmin ? 'Administrator' : 'Mitarbeiter';
        
        topUserText.textContent = `${name} (${roleText})`;
        logoutBtn.classList.remove('hidden');
        userNameText.textContent = name;
        sidebarUserRole.textContent = `Rolle: ${roleText}`;

        // Role Badge
        roleBadge.textContent = isAdmin
            ? 'ADMIN'
            : (profile.employment_type === 'fulltime' ? 'Vollzeit' : 'Minijob');
        roleBadge.style.background = isAdmin
            ? '#bbdefb'
            : (profile.employment_type === 'fulltime' ? '#e8f5e9' : '#fff3e0');
        roleBadge.style.color = isAdmin
            ? 'var(--blue-dark)'
            : (profile.employment_type === 'fulltime' ? '#2e7d32' : '#ff9800');
        roleBadge.classList.remove('hidden');

        // Admin Links
        if (isAdmin) {
            sidebarAdminLink.classList.remove('hidden');
            sidebarAdminUploadsLink.classList.remove('hidden');
            sidebarAdminLabel.classList.remove('hidden');
            tileAdmin.classList.remove('hidden');
            tileAdminUploads.classList.remove('hidden');
            loadPendingUserCount();
        } else {
            sidebarAdminLink.classList.add('hidden');
            sidebarAdminUploadsLink.classList.add('hidden');
            sidebarAdminLabel.classList.add('hidden');
            tileAdmin.classList.add('hidden');
            tileAdminUploads.classList.add('hidden');
        }

        // Initial Section
        setActiveSection('section-dashboard');
        resetInactivityTimer();
    }

// --- AUTH HANDLERS ---

    loginBtn.addEventListener('click', async () => {
        if (!supabaseClient) return showAuthError('Kritischer Fehler: Anmeldefunktion nicht verfÃ¼gbar.'); // Safety check

        clearAuthMessages();
        const email = emailInput.value;
        const password = passwordInput.value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password,
        });

        if (error) {
            showAuthError(error.message);
        } else if (data.user) {
            await showPortal(data.user);
        }
    });

    // Passwort-vergessen Flow: erst eigenes Formular mit nur E-Mail-Feld anzeigen
    forgotPasswordBtn.addEventListener('click', () => {
        clearAuthMessages();
        // Wenn im Login schon eine E-Mail eingetragen ist, Ã¼bernehmen
        forgotEmailInput.value = emailInput.value.trim();
        loginBox.classList.add('hidden');
        registerBox.classList.add('hidden');
        resetBox.classList.add('hidden');
        forgotBox.classList.remove('hidden');
    });

    // E-Mail zum ZurÃ¼cksetzen des Passworts senden
    forgotSendBtn.addEventListener('click', async () => {
        if (!supabaseClient) return showAuthError('Kritischer Fehler: Funktion nicht verfÃ¼gbar.'); // Safety check

        clearAuthMessages();
        const email = forgotEmailInput.value.trim();
        if (!email) {
            return showAuthError('Bitte E-Mail eingeben.');
        }

        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + window.location.pathname + '#reset',
        });

        if (error) {
            showAuthError('Fehler: ' + error.message);
        } else {
            showAuthSuccess('E-Mail zum ZurÃ¼cksetzen des Passworts gesendet. Bitte Posteingang prÃ¼fen.');
            // Nach erfolgreichem Versand zurÃ¼ck zum Login
            forgotBox.classList.add('hidden');
            loginBox.classList.remove('hidden');
        }
    });

    // ZurÃ¼ck vom "Passwort vergessen"-Formular zum Login
    forgotBackBtn.addEventListener('click', () => {
        clearAuthMessages();
        forgotBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
    });

    registerBtn.addEventListener('click', async () => {
        if (!supabaseClient) return showAuthError('Kritischer Fehler: Registrierung nicht verfÃ¼gbar.'); // Safety check

        clearAuthMessages();
        const firstName = regFirstName.value.trim();
        const lastName = regLastName.value.trim();
        const email = regEmail.value.trim();
        const password = regPassword.value;
        const password2 = regPassword2.value;

        if (!firstName || !lastName || !email || !password || !password2) {
            return showAuthError('Bitte alle Felder ausfÃ¼llen.');
        }

        if (password !== password2) {
            return showAuthError('PasswÃ¶rter stimmen nicht Ã¼berein.');
        }

        if (!isStrongPassword(password)) {
            return showAuthError('Passwort zu schwach (min 8 Zeichen, 1 GroÃŸbuchstabe, 1 Zahl/Sonderzeichen).');
        }

        const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                emailRedirectTo: window.location.origin + window.location.pathname,
                data: {
                    first_name: firstName,
                    last_name: lastName,
                    full_name: `${firstName} ${lastName}`,
                    role: 'user'
                }
            }
        });

        if (error) {
            showAuthError(error.message);
        } else if (data.user) {
            // After successful signup, insert initial profile data
            const { error: profileError } = await supabaseClient
                .from('profiles')
                .insert([
                    {
                        id: data.user.id,
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        full_name: `${firstName} ${lastName}`,
                        role: 'user', // Default role
                        is_approved: false, // Must be approved by admin
                        employment_type: null // Wird erst bei Freigabe gesetzt
                    }
                ]);

            if (profileError) {
                console.error('Profile insertion error:', profileError);
                // Continue, as the user is created in auth
            }

            showAuthSuccess('Registrierung erfolgreich! Bitte E-Mail bestÃ¤tigen. Nach BestÃ¤tigung muss ein Admin Ihren Zugang freigeben.');
            // Switch back to login box
            registerBox.classList.add('hidden');
            loginBox.classList.remove('hidden');
        }
    });

    resetPasswordBtn.addEventListener('click', async () => {
        if (!supabaseClient) return; // Safety check
        
        const n1 = resetPassword.value;
        const n2 = resetPassword2.value;

        if (!isStrongPassword(n1)) {
            return alert('Passwort zu schwach (min 8, GroÃŸbuchstabe, Zahl/Sonderzeichen).');
        }

        if (n1 !== n2) {
            return alert('Neue PasswÃ¶rter stimmen nicht Ã¼berein.');
        }

        const { error: updateError } = await supabaseClient.auth.updateUser({ password: n1 });

        if (updateError) {
            alert('Fehler: ' + updateError.message);
        } else {
            alert('Passwort geÃ¤ndert.');
            window.location.hash = ''; // Clear recovery token
            resetBox.classList.add('hidden');
            loginBox.classList.remove('hidden');
        }
    });

    logoutBtn.addEventListener('click', async () => {
        if (!supabaseClient) return showLogin(); // Safety check
        await supabaseClient.auth.signOut();
        showLogin();
    });
    
    pendingLogoutBtn.addEventListener('click', async () => {
        if (!supabaseClient) return showLogin(); // Safety check
        await supabaseClient.auth.signOut();
        showLogin();
    });

    showRegisterBtn.addEventListener('click', () => {
        loginBox.classList.add('hidden');
        registerBox.classList.remove('hidden');
        clearAuthMessages();
        
        // NEU: Fokus auf das erste Eingabefeld setzen
        regFirstName.focus();
    });

    backToLoginBtn.addEventListener('click', () => {
        registerBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
        clearAuthMessages();
        
        // NEU: Fokus auf das E-Mail Feld setzen
        emailInput.focus();
    });

    // NEU: Event-Listener fÃ¼r ENTER-Taste
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            loginBtn.click();
        }
    });

    regPassword2.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            registerBtn.click();
        }
    });

    resetPassword2.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            resetPasswordBtn.click();
        }
    });
    // ENDE NEU

    // --- INITIALIZATION ---

    async function init() {
        if (!supabaseClient) {
             // Kritischer Fehler beim Initialisieren des Supabase Clients
             authSection.classList.remove('hidden');
             portalSection.classList.add('hidden');
             pendingSection.classList.add('hidden');
             showAuthError('Kritischer Fehler: Das Portal konnte nicht initialisiert werden. Bitte prÃ¼fen Sie Ihre Supabase-Konfiguration oder die Internetverbindung (siehe Konsole).');
             disableAuthButtons(); // Deaktiviert alle Anmelde-Buttons
             return;
        }

        initNavigation();
        setupActivityListeners();
        
        // NEU: Event-Listener fÃ¼r Passwort-Umschalter hinzufÃ¼gen
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', handlePasswordToggle);
        });

        // Check for Recovery Hash (Passwort zurÃ¼cksetzen)
        if(window.location.hash.includes('type=recovery')) {
             authSection.classList.remove('hidden');
             loginBox.classList.add('hidden');
             resetBox.classList.remove('hidden');
             // Benutzer ist bereits angemeldet, um das PW zurÃ¼ckzusetzen. Kein showLogin/showPortal nÃ¶tig.
             return; 
        }

        // Check for Signup Confirmation (E-Mail-BestÃ¤tigung)
        if(window.location.hash.includes('type=signup')) {
             // Zeige eine klare RÃ¼ckmeldung nach E-Mail-BestÃ¤tigung
             authSection.classList.remove('hidden');
             portalSection.classList.add('hidden');
             pendingSection.classList.add('hidden');
             loginBox.classList.remove('hidden');
             registerBox.classList.add('hidden');
             resetBox.classList.add('hidden');
             showAuthSuccess('Ihre Eâ€‘Mail-Adresse wurde erfolgreich bestÃ¤tigt. Ein Administrator muss Ihren Zugang noch freigeben. Sie kÃ¶nnen sich einloggen, sobald Sie freigeschaltet wurden.');
             return;
        }

        const { data } = await supabaseClient.auth.getSession();
        if (data.session) {
            await showPortal(data.session.user);
        } else {
            showLogin();
        }
    }

    // --- STORAGE & DOCUMENTS (COMMON) ---

    async function uploadFileToStorage(file, folder) {
        // ... (Logik wie zuvor)
        const fileExtension = file.name.split('.').pop();
        const safeFileName = makeSafeFileName(file.name);
        const filePath = `${folder}/${Date.now()}_${safeFileName}`;
        
        const { data, error } = await supabaseClient.storage
            .from(STORAGE_BUCKET)
            .upload(filePath, file);

        if (error) {
            throw error;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from(STORAGE_BUCKET)
            .getPublicUrl(filePath);

        return urlData.publicUrl;
    }

    async function insertDocumentRow(userId, title, docType, fileUrl) {
        const { error } = await supabaseClient
            .from('documents')
            .insert({ user_id: userId, title: title, doc_type: docType, file_url: fileUrl });
        if (error) throw error;
    }

    function renderDocumentList(listEl, docs) {
        // ... (Logik wie zuvor)
        listEl.innerHTML = '';
        if (!docs || docs.length === 0) return;

        docs.forEach(doc => {
            const li = document.createElement('li');
            li.className = 'document-item';

            const div = document.createElement('div');
            const titleDiv = document.createElement('div');
            titleDiv.className = 'document-item-title';
            titleDiv.textContent = doc.title;
            
            const metaDiv = document.createElement('div');
            metaDiv.className = 'document-item-meta';
            const dateStr = new Date(doc.created_at).toLocaleDateString('de-DE');
            metaDiv.textContent = `${doc.doc_type} â€¢ ${dateStr}`;
            
            div.appendChild(titleDiv);
            div.appendChild(metaDiv);

            const link = document.createElement('a');
            link.href = doc.file_url;
            link.target = '_blank';
            link.textContent = 'Ã–ffnen';

            li.appendChild(div);
            li.appendChild(link);
            listEl.appendChild(li);
        });
    }

    async function loadDocumentsForUser(user) {
        // ... (Logik wie zuvor)
        const { data: docs, error } = await supabaseClient
            .from('documents')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error(error);
            return;
        }

        const unterweisungen = docs.filter(d => d.doc_type === 'unterweisung' || !d.doc_type);
        const timesheets = docs.filter(d => d.doc_type === 'stundenzettel');
        const sicknotes = docs.filter(d => d.doc_type === 'krankmeldung');

        if(unterweisungen.length > 0) docsUnterwMessage.classList.add('hidden');
        else docsUnterwMessage.classList.remove('hidden');
        renderDocumentList(docsUnterwList, unterweisungen);

        if(timesheets.length > 0) docsTimesheetsMessage.classList.add('hidden');
        else docsTimesheetsMessage.classList.remove('hidden');
        renderDocumentList(docsTimesheetsList, timesheets);

        if(sicknotes.length > 0) sicknotesUserMessage.classList.add('hidden');
        else sicknotesUserMessage.classList.remove('hidden');
        renderDocumentList(docsSicknotesList, sicknotes);
    }

    // --- UPLOAD HANDLERS (USER) ---

    async function handleUserUpload(fileInput, docType, folder) {
        // ... (Logik wie zuvor)
        const file = fileInput.files[0];
        if (!file || !currentUser) return;

        try {
            const url = await uploadFileToStorage(file, `${folder}/${currentUser.id}`);
            const dateStr = new Date().toLocaleDateString('de-DE');
            const title = `${docType === 'stundenzettel' ? 'Stundenzettel' : 'Krankmeldung'} ${dateStr} â€“ ${file.name}`;
            
            await insertDocumentRow(currentUser.id, title, docType, url);
            
            alert('Upload erfolgreich!');
            loadDocumentsForUser(currentUser);
        } catch (e) {
            console.error('Upload Error:', e);
            alert('Upload fehlgeschlagen: ' + (e.message || e));
        } finally {
            fileInput.value = null; // Reset input field
        }
    }

    uploadTimesheetBtn.addEventListener('click', () => {
        uploadTimesheetInput.click();
    });

    uploadTimesheetInput.addEventListener('change', () => {
        handleUserUpload(uploadTimesheetInput, 'stundenzettel', 'timesheets');
    });

    uploadSicknoteBtn.addEventListener('click', () => {
        uploadSicknoteInput.click();
    });

    uploadSicknoteInput.addEventListener('change', () => {
        handleUserUpload(uploadSicknoteInput, 'krankmeldung', 'sicknotes');
    });

    // --- ADMIN USER MANAGEMENT ---

    async function loadAllProfiles() {
        // LÃ¤dt alle Profile nur aus der Tabelle "profiles"
        const { data: profiles, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .order('created_at', { ascending: true });

        if (error) {
            console.error('Error loading profiles:', error);
            return [];
        }

        // Kein auth.admin.listUsers() im Browser â€“ nur Profile verwenden
        allProfilesCache = profiles;
        return profiles;
    }
async function loadPendingUserCount() {
        const profiles = await loadAllProfiles();
        const pending = profiles.filter(p => !p.is_approved);
        updatePendingBadges(pending.length);
    }

    function renderGroup(heading, profiles) {
        // ... (Logik wie zuvor)
        if(profiles.length === 0) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'employee-category-wrapper';
        
        const h = document.createElement('div');
        h.className = 'employee-category-heading';
        h.textContent = heading + ` (${profiles.length})`;
        wrapper.appendChild(h);

        const grid = document.createElement('div');
        grid.className = 'employee-grid';

        profiles.forEach(p => {
            const initials = (p.full_name || p.email).substring(0,2).toUpperCase();
            const card = document.createElement('div');
            card.className = 'employee-card';
            if(p.role === 'admin') card.classList.add('admin');
            
            // Role Select
            const roleSel = document.createElement('select');
            roleSel.innerHTML = `<option value="user" ${p.role === 'user' ? 'selected' : ''}>Mitarbeiter</option><option value="admin" ${p.role === 'admin' ? 'selected' : ''}>Administrator</option>`;
            
            // Type Select
            const typeSel = document.createElement('select');
            typeSel.innerHTML = `<option value="fulltime" ${p.employment_type === 'fulltime' ? 'selected' : ''}>Vollzeit</option><option value="minijob" ${p.employment_type === 'minijob' ? 'selected' : ''}>Minijob</option>`;
            typeSel.disabled = (p.role === 'admin');

            // Hide Art if Admin role
            roleSel.addEventListener('change', () => {
                typeSel.disabled = (roleSel.value === 'admin');
            });
            
            const actions = document.createElement('div');
            actions.className = 'employee-actions';
            
            const btnSave = document.createElement('button');
            btnSave.className = 'btn-small primary';
            btnSave.textContent = 'Speichern';
            btnSave.onclick = () => updateUserStatus(p.id, roleSel.value, typeSel.value);
            
            const btnOpen = document.createElement('button');
            btnOpen.className = 'btn-small grey';
            btnOpen.textContent = 'Details';
            btnOpen.onclick = () => openEmployeeDetail(p);
            
            actions.appendChild(btnOpen);
            actions.appendChild(btnSave);

            card.innerHTML = `
                <div class="employee-avatar" style="border-color:${p.role === 'admin' ? 'var(--blue-dark)' : (p.employment_type === 'fulltime' ? '#4caf50' : '#ff9800')}">${initials}</div>
                <div>
                    <div class="employee-info-main">${p.full_name || '-'}</div>
                    <div class="employee-info-sub">${p.email}</div>
                    <div class="employee-role-selector"><label>Rolle:</label></div>
                </div>
            `;
            card.querySelector('.employee-role-selector').appendChild(roleSel);
            
            // Type Selector Container
            const typeDiv = document.createElement('div');
            typeDiv.className = 'employee-role-selector';
            typeDiv.innerHTML = '<label>Art:</label>';
            typeDiv.appendChild(typeSel);
            card.children[1].appendChild(typeDiv);
            
            card.children[1].appendChild(actions);
            grid.appendChild(card);
        });

        wrapper.appendChild(grid);
        approvedEmployeesContent.appendChild(wrapper);
    }

    function renderPendingGroup(profiles) {
        // ... (Logik wie zuvor)
        pendingEmployeesContent.innerHTML = '';
        noPendingUsers.classList.add('hidden');

        if(profiles.length === 0) {
            noPendingUsers.classList.remove('hidden');
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'employee-grid';

        profiles.forEach(p => {
            const initials = (p.full_name || p.email).substring(0,2).toUpperCase();
            const card = document.createElement('div');
            card.className = 'employee-card pending';
            
            // Role Select (Initial default to user)
            const roleSel = document.createElement('select');
            roleSel.innerHTML = `<option value="user">Mitarbeiter</option><option value="admin">Administrator</option>`;
            
            // Type Select (Initial default to fulltime)
            const typeSel = document.createElement('select');
            typeSel.innerHTML = `<option value="fulltime">Vollzeit</option><option value="minijob">Minijob</option>`;

            // Hide Art if Admin role
            roleSel.addEventListener('change', () => {
                typeSel.disabled = (roleSel.value === 'admin');
            });
            
            const actions = document.createElement('div');
            actions.className = 'employee-actions';
            
            const btnApprove = document.createElement('button');
            btnApprove.className = 'btn-small approve';
            btnApprove.textContent = 'Freigeben';
            btnApprove.onclick = () => approveUser(p.id, roleSel.value, typeSel.value);
            
            const btnOpen = document.createElement('button');
            btnOpen.className = 'btn-small grey';
            btnOpen.textContent = 'Details';
            btnOpen.onclick = () => openEmployeeDetail(p);
            
            actions.appendChild(btnOpen);
            actions.appendChild(btnApprove);

            card.innerHTML = `
                <div class="employee-avatar" style="border-color:#ff9800">${initials}</div>
                <div>
                    <div class="employee-info-main">${p.full_name || '-'}</div>
                    <div class="employee-info-sub">${p.email}</div>
                    <div class="employee-info-sub" style="color:#e65100">Wartet auf Freigabe</div>
                    <div class="employee-role-selector"><label>Rolle:</label></div>
                </div>
            `;
            
            card.querySelector('.employee-role-selector').appendChild(roleSel);
            
            const typeDiv = document.createElement('div');
            typeDiv.className = 'employee-role-selector';
            typeDiv.innerHTML = '<label>Art:</label>';
            typeDiv.appendChild(typeSel);
            card.children[1].appendChild(typeDiv);
            
            card.children[1].appendChild(actions);
            grid.appendChild(card);
        });

        pendingEmployeesContent.appendChild(grid);
    }

    async function loadEmployeeGrid() {
        // ... (Logik wie zuvor)
        const profiles = await loadAllProfiles();

        const pending = profiles.filter(p => !p.is_approved);
        const approved = profiles.filter(p => p.is_approved);

        renderPendingGroup(pending);
        updatePendingBadges(pending.length);

        const admins = approved.filter(p => p.role === 'admin');
        const fulltime = approved.filter(p => p.role !== 'admin' && p.employment_type === 'fulltime');
        const minijob = approved.filter(p => p.role !== 'admin' && p.employment_type === 'minijob');
        const others = approved.filter(p => p.role !== 'admin' && p.employment_type !== 'fulltime' && p.employment_type !== 'minijob');

        approvedEmployeesContent.innerHTML = '';
        renderGroup('Administratoren', admins);
        renderGroup('Vollzeit-Mitarbeiter', fulltime);
        renderGroup('Minijob-Mitarbeiter', minijob);
        renderGroup('Sonstige Mitarbeiter', others);

        // Update User Select for Uploads
        populateAdminUploadSelect(approved);
    }

    function updatePendingBadges(count) {
        // ... (Logik wie zuvor)
        const txt = count > 0 ? count : '';
        sidebarAdminBadge.textContent = txt;
        tileAdminBadge.textContent = txt;
        adminRequestsCounter.textContent = txt;

        if(count > 0) {
            sidebarAdminBadge.classList.remove('hidden');
            tileAdminBadge.classList.remove('hidden');
            adminRequestsCounter.classList.remove('hidden');
        } else {
            sidebarAdminBadge.classList.add('hidden');
            tileAdminBadge.classList.add('hidden');
            adminRequestsCounter.classList.add('hidden');
        }
    }

    async function approveUser(id, role, empType) {
        // ... (Logik wie zuvor)
        if(!confirm('Benutzer wirklich freigeben?')) return;

        const updates = {
            is_approved: true,
            approved_at: new Date(),
            approved_by: currentUser.id,
            role: role,
            employment_type: (role === 'admin') ? null : empType
        };

        const targetProfile = allProfilesCache.find(p => p.id === id) || null;
        const { error } = await supabaseClient.from('profiles').update(updates).eq('id', id);

        if(error) {
            alert('Fehler: ' + error.message);
        } else {
            // Optional: E-Mail-Benachrichtigung Ã¼ber Freigabe auslÃ¶sen
            if (targetProfile && targetProfile.email) {
                sendApprovalNotificationEmail(targetProfile, updates);
            }
            loadEmployeeGrid();
        }
    }

    async function updateUserStatus(id, role, empType) {
        // ... (Logik wie zuvor)
        const updates = {
            role: role,
            employment_type: (role === 'admin') ? null : empType
        };

        const { error } = await supabaseClient.from('profiles').update(updates).eq('id', id);

        if(error) alert('Fehler: ' + error.message);
        else {
            alert('Daten aktualisiert');
            loadEmployeeGrid();
        }
    }

    
    // Optionale E-Mail-Benachrichtigung bei Freigabe
    // Hinweis: Damit wirklich E-Mails versendet werden, muss in Supabase
    // eine Edge Function "send-approval-email" eingerichtet werden, die
    // die eigentliche Mail verschickt. Diese Funktion wird hier nur aufgerufen.
    async function sendApprovalNotificationEmail(profile, updates) {
        try {
            if (!supabaseClient || !profile || !profile.email) return;

            await supabaseClient.functions.invoke('send-approval-email', {
                body: {
                    user_id: profile.id,
                    email: profile.email,
                    first_name: profile.first_name,
                    last_name: profile.last_name,
                    full_name: profile.full_name,
                    role: updates.role,
                    employment_type: updates.employment_type
                }
            });
        } catch (e) {
            console.warn('Konnte Freigabe-E-Mail nicht versenden (Edge Function fehlt oder Fehler):', e);
        }
    }

// --- ADMIN UPLOAD ---
    
    function populateAdminUploadSelect(profiles) {
        // ... (Logik wie zuvor)
        adminUnterwUserSelect.innerHTML = '';
        profiles.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.full_name || p.email;
            adminUnterwUserSelect.appendChild(opt);
        });
    }

    adminUnterwScope.addEventListener('change', () => {
        if(adminUnterwScope.value === 'single') adminUnterwUserSelectWrapper.classList.remove('hidden');
        else adminUnterwUserSelectWrapper.classList.add('hidden');
    });

    adminUnterwUploadBtn.addEventListener('click', async () => {
        // ... (Logik wie zuvor)
        adminUnterwMessage.textContent = '';
        adminUnterwMessage.style.color = 'red';

        const file = adminUnterwInput.files[0];
        if (!file) {
            adminUnterwMessage.textContent = 'Bitte eine Datei auswÃ¤hlen.';
            return;
        }

        const scope = adminUnterwScope.value;
        const targetUserId = scope === 'single' ? adminUnterwUserSelect.value : null;

        if (scope === 'single' && !targetUserId) {
            adminUnterwMessage.textContent = 'Bitte einen Mitarbeiter auswÃ¤hlen.';
            return;
        }

        const isMulti = scope === 'all';
        let targetUsers = [];

        if (isMulti) {
            targetUsers = allProfilesCache.filter(p => p.is_approved && p.role === 'user').map(p => p.id);
            if (targetUsers.length === 0) {
                adminUnterwMessage.textContent = 'Keine freigegebenen Mitarbeiter zum Hochladen gefunden.';
                return;
            }
        } else {
            targetUsers = [targetUserId];
        }

        adminUnterwMessage.textContent = 'Upload lÃ¤uft... Bitte warten.';
        adminUnterwMessage.style.color = 'orange';
        adminUnterwUploadBtn.disabled = true;

        try {
            // 1. Upload file once to a general admin folder
            const folder = 'unterweisungen_admin';
            const url = await uploadFileToStorage(file, folder);

            // 2. Insert document row for each target user
            const dateStr = new Date().toLocaleDateString('de-DE');
            const title = `Unterweisung ${dateStr} â€“ ${file.name}`;
            const insertPromises = targetUsers.map(userId => 
                insertDocumentRow(userId, title, 'unterweisung', url)
            );

            await Promise.all(insertPromises);

            adminUnterwMessage.textContent = `Erfolgreich fÃ¼r ${targetUsers.length} Benutzer hochgeladen.`;
            adminUnterwMessage.style.color = 'green';
            adminUnterwInput.value = null; // Reset input

        } catch (e) {
            console.error('Admin Upload Error:', e);
            adminUnterwMessage.textContent = 'Upload fehlgeschlagen: ' + (e.message || e);
        } finally {
            adminUnterwUploadBtn.disabled = false;
        }
    });

    // --- ADMIN OVERVIEWS ---

    function renderAdminGroupedList(docs, container) {
        // ... (Logik wie zuvor)
        container.innerHTML = '';
        if(docs.length === 0) {
            container.textContent = 'Keine EintrÃ¤ge.';
            return;
        }

        // Group by User -> Month
        const map = {};
        docs.forEach(d => {
            // Find name from cache
            const prof = allProfilesCache.find(p => p.id === d.user_id);
            const name = prof ? prof.full_name : 'Unbekannt';
            
            const date = new Date(d.created_at);
            const key = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}`;

            if(!map[name]) map[name] = {};
            if(!map[name][key]) map[name][key] = [];
            
            map[name][key].push(d);
        });

        for (const [name, months] of Object.entries(map)) {
            const userDiv = document.createElement('div');
            userDiv.className = 'admin-overview-entry';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'admin-overview-name';
            nameDiv.textContent = name;
            userDiv.appendChild(nameDiv);

            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.padding = '0';
            ul.style.margin = '0';

            for (const [monthKey, monthDocs] of Object.entries(months)) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'admin-overview-details';
                monthDiv.style.fontWeight = 'bold';
                monthDiv.textContent = `${monthKey} (${monthDocs.length}x):`;
                userDiv.appendChild(monthDiv);
                
                monthDocs.forEach(doc => {
                    const li = document.createElement('li');
                    li.className = 'admin-overview-details';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.padding = '2px 0';

                    const date = new Date(doc.created_at).toLocaleDateString('de-DE');

                    const infoSpan = document.createElement('span');
                    infoSpan.textContent = `${date} â€“ ${doc.title}`;
                    infoSpan.style.fontSize = '0.8rem';

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'admin-overview-actions';

                    const link = document.createElement('a');
                    link.href = doc.file_url;
                    link.target = '_blank';
                    link.textContent = 'Ã–ffnen';
                    link.style.fontSize = '0.8rem';

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.className = 'btn-link-danger';
                    delBtn.textContent = 'LÃ¶schen';
                    delBtn.addEventListener('click', () => {
                        deleteDocumentAsAdmin(doc);
                    });

                    actionsDiv.appendChild(link);
                    actionsDiv.appendChild(delBtn);

                    li.appendChild(infoSpan);
                    li.appendChild(actionsDiv);
                    ul.appendChild(li);
                });
            }
            userDiv.appendChild(ul);
            container.appendChild(userDiv);
        }
    }


    async function deleteDocumentAsAdmin(doc) {
        if (!currentProfile || currentProfile.role !== 'admin') return;
        if (!confirm('MÃ¶chten Sie dieses Dokument wirklich lÃ¶schen?')) return;

        try {
            // Pfad aus der Ã¶ffentlichen URL extrahieren
            let path = null;
            if (doc.file_url) {
                const prefix = '/storage/v1/object/public/documents/';
                const idx = doc.file_url.indexOf(prefix);
                if (idx !== -1) {
                    path = doc.file_url.substring(idx + prefix.length);
                }
            }

            if (path) {
                const { error: storageError } = await supabaseClient
                    .storage
                    .from('documents')
                    .remove([path]);
                if (storageError) {
                    console.error('Fehler beim LÃ¶schen aus Storage:', storageError);
                }
            }

            const { error: dbError } = await supabaseClient
                .from('documents')
                .delete()
                .eq('id', doc.id);

            if (dbError) {
                throw dbError;
            }

            // Ãœbersicht neu laden
            await loadAdminDocumentOverviews();
        } catch (e) {
            console.error('Admin Delete Error:', e);
            alert('LÃ¶schen fehlgeschlagen: ' + (e.message || e));
        }
    }

    async function loadAdminDocumentOverviews() {
        // ... (Logik wie zuvor)
        if(currentProfile?.role !== 'admin') return;

        // Ensure profiles are loaded for names
        if(allProfilesCache.length === 0) {
            await loadAllProfiles();
        }

        const { data: docs, error } = await supabaseClient
            .from('documents')
            .select('*')
            .in('doc_type', ['stundenzettel', 'krankmeldung'])
            .order('created_at', { ascending: false });

        if(error) return;

        // Load Last Seen
        const lastTs = localStorage.getItem('bayrak_admin_last_opened_timesheets') || '1970-01-01';
        const lastSn = localStorage.getItem('bayrak_admin_last_opened_sicknotes') || '1970-01-01';

        // Filter Lists
        const tsDocs = docs.filter(d => d.doc_type === 'stundenzettel');
        const snDocs = docs.filter(d => d.doc_type === 'krankmeldung');

        // Count New
        const newTs = tsDocs.filter(d => new Date(d.created_at) > new Date(lastTs)).length;
        const newSn = snDocs.filter(d => new Date(d.created_at) > new Date(lastSn)).length;

        adminTimesheetsNewCount.textContent = newTs > 0 ? `${newTs} neue Uploads seit letztem Besuch` : 'Keine neuen Uploads.';
        adminSicknotesNewCount.textContent = newSn > 0 ? `${newSn} neue Uploads seit letztem Besuch` : 'Keine neuen Uploads.';

        renderAdminGroupedList(tsDocs, adminTimesheetsOverview);
        renderAdminGroupedList(snDocs, adminSicknotesOverview);

        // Update Last Seen
        localStorage.setItem('bayrak_admin_last_opened_timesheets', new Date().toISOString());
        localStorage.setItem('bayrak_admin_last_opened_sicknotes', new Date().toISOString());
    }

    // --- EMPLOYEE DETAIL ---

    async function openEmployeeDetail(profile) {
        // ... (Logik wie zuvor)
        setActiveSection('section-employee-detail');

        employeeDetailInfoTitle.textContent = profile.full_name || profile.email;
        const roleText = profile.role === 'admin' ? 'Administrator' : `Mitarbeiter (${profile.employment_type || 'N/A'})`;
        const approvalText = profile.is_approved ? `Freigegeben am ${new Date(profile.approved_at).toLocaleDateString('de-DE')}` : 'Wartet auf Freigabe';
        employeeDetailMeta.textContent = `E-Mail: ${profile.email} Â· Rolle: ${roleText} Â· Status: ${approvalText}`;

        // Load Documents for this specific user
        const { data: docs, error } = await supabaseClient
            .from('documents')
            .select('*')
            .eq('user_id', profile.id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error(error);
            employeeDetailDocs.innerHTML = `<li class="document-item"><div class="document-item-title error">Fehler beim Laden der Dokumente: ${error.message}</div></li>`;
            return;
        }

        renderDocumentList(employeeDetailDocs, docs);
        if(docs.length === 0) {
            employeeDetailDocs.innerHTML = `<li class="document-item"><div class="document-item-title info">Keine Dokumente hochgeladen oder zugewiesen.</div></li>`;
        }
    }

    // --- SETTINGS HANDLERS ---

    settingsSaveProfile.addEventListener('click', async () => {
        // ... (Logik wie zuvor)
        settingsProfileMsg.textContent = '';
        settingsProfileMsg.style.color = 'red';

        const firstName = settingsFirstName.value.trim();
        const lastName = settingsLastName.value.trim();
        const employmentType = settingsEmploymentType.value;
        const fullName = `${firstName} ${lastName}`;

        if (!firstName || !lastName) {
            settingsProfileMsg.textContent = 'Vor- und Nachname dÃ¼rfen nicht leer sein.';
            return;
        }

        // 1. Update Profile Table
        const updates = {
            full_name: fullName,
            employment_type: employmentType
        };

        const { error: profileError } = await supabaseClient
            .from('profiles')
            .update(updates)
            .eq('id', currentUser.id);

        if (profileError) {
            settingsProfileMsg.textContent = 'Fehler beim Speichern der Profildaten: ' + profileError.message;
            settingsProfileMsg.style.color = 'red';
            return;
        }

        // 2. Update Auth Meta
        const { error: authError } = await supabaseClient.auth.updateUser({
            data: { full_name: fullName }
        });
        
        if (authError) {
            settingsProfileMsg.textContent = 'Fehler beim Aktualisieren des Auth-Namen: ' + authError.message;
            settingsProfileMsg.style.color = 'red';
        } else {
            settingsProfileMsg.textContent = 'Gespeichert.';
            settingsProfileMsg.style.color = 'green';
            userNameText.textContent = fullName;
            currentProfile.full_name = fullName; // Update cache
            // Reload user info in top bar and sidebar for immediate effect
            showPortal(currentUser); 
        }
    });

    settingsChangePw.addEventListener('click', async () => {
        // ... (Logik wie zuvor)
        const cur = settingsCurrentPw.value;
        const n1 = settingsNewPw.value;
        const n2 = settingsNewPw2.value;

        if(!isStrongPassword(n1)) return alert('Passwort zu schwach (min 8, GroÃŸbuchstabe, Zahl/Sonderzeichen).');
        if(n1 !== n2) return alert('Neue PasswÃ¶rter stimmen nicht Ã¼berein.');

        // Re-Auth to verify current password
        const { error: signInError } = await supabaseClient.auth.signInWithPassword({
            email: currentUser.email,
            password: cur
        });

        if(signInError) {
            settingsPasswordMsg.textContent = 'Aktuelles Passwort falsch.';
            settingsPasswordMsg.style.color = 'red';
            return;
        }

        const { error: updateError } = await supabaseClient.auth.updateUser({ password: n1 });

        if(updateError) {
            settingsPasswordMsg.textContent = 'Fehler: ' + updateError.message;
        } else {
            settingsPasswordMsg.textContent = 'Passwort geÃ¤ndert.';
            settingsPasswordMsg.style.color = 'green';
            settingsCurrentPw.value = '';
            settingsNewPw.value = '';
            settingsNewPw2.value = '';
        }
    });


    // Start App
    init();

</script>
</body>

</html>